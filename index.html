<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¯è¯­æ‹¼è¯»ç»ƒä¹ </title>
  <style>
    :root{
      --c1:#FF6F61; --c2:#FFB74D; --c3:#4DB6AC; --c4:#64B5F6; --c5:#BA68C8;
      --bg1:#FFF3E0; --bg2:#E1F5FE;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Comic Sans MS","Helvetica Neue",Arial,"PingFang SC",sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2),#F3E5F5);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
      overflow-x:hidden;
    }
    .wrap{
      width:100%; max-width:980px; background:#fff; border-radius:18px;
      padding:18px; box-shadow:0 12px 40px rgba(0,0,0,0.12); position:relative; z-index:1;
    }
    header{display:flex; align-items:center; gap:12px}
    .logo{width:84px; height:84px; border-radius:18px;
      background:conic-gradient(from 45deg,var(--c1),var(--c2),var(--c3),var(--c4),var(--c5),var(--c1));
      display:flex; align-items:center; justify-content:center; color:#fff; font-size:40px; font-weight:900;
      box-shadow:0 8px 26px rgba(0,0,0,0.18)}
    h1{margin:0; font-size:24px; color:var(--c1)}
    main{margin-top:14px}

    #home{display:block}
    .card{background:#fff; border-radius:14px; padding:14px; box-shadow:0 8px 22px rgba(0,0,0,0.06); margin-bottom:14px}
    .grade-selects{display:flex; gap:12px; flex-wrap:wrap; margin-top:12px}
    .grade-btn{flex:1; min-width:120px; padding:14px; border-radius:12px; font-weight:900;
      background:linear-gradient(135deg,var(--c2),var(--c1)); color:#fff; text-align:center; cursor:pointer; transition:.15s}
    .grade-btn.selected{outline:5px solid #64B5F6; transform:translateY(-4px)}
    .num-select{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .num-btn{padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer;
      background:linear-gradient(135deg,var(--c3),var(--c4)); color:#fff}
    .num-btn.selected{outline:4px solid #FFB74D; transform:scale(1.03)}
    .custom-box{display:flex; align-items:center; gap:8px; margin-top:10px}
    .custom-input{width:90px; padding:8px; border:3px solid var(--c4); border-radius:10px; text-align:center; font-weight:700}
    .start-btn{background:linear-gradient(90deg,var(--c1),var(--c2)); border:none; color:#fff;
      padding:14px 20px; border-radius:14px; font-weight:900; font-size:16px; cursor:pointer;
      box-shadow:0 8px 28px rgba(0,0,0,0.18); margin-top:14px}

    #game{display:none; position:relative}
    .animal-emoji{position:fixed; font-size:40px; opacity:0.5; z-index:0; pointer-events:none}
    .animal-1{top:6%; left:17%} .animal-2{top:8%; right:12%} .animal-3{bottom:15%; left:5%}
    .animal-4{bottom:12%; right:8%} .animal-5{top:40%; left:3%} .animal-6{top:55%; right:5%}

    .game-content{display:flex; width:100%; gap:20px; margin:14px 0; position:relative; z-index:1}
    .char-box{flex:1; text-align:center; padding:10px}
    .char-box .word{font-size:72px; font-weight:900; color:var(--c1)}
    .meta{font-size:16px; margin-top:6px; color:#333}
    .play-btn{margin-top:8px; padding:8px 14px; border:none; border-radius:12px;
      background:linear-gradient(90deg,var(--c3),var(--c4)); color:#fff; font-weight:800; cursor:pointer}

    .choices{flex:1; display:flex; flex-direction:column; gap:12px; margin-top:14px;
      transition:opacity 0.6s ease} /* æ–°å¢æ·¡å‡ºåŠ¨ç”» */
    .choice{padding:16px; border-radius:14px; font-weight:900; font-size:22px; cursor:pointer;
      background:linear-gradient(135deg,#FFFDE7,#FFF9C4); border:3px solid rgba(0,0,0,0.03); transition:.12s;
      text-align:center}
    .choice:hover{transform:translateY(-4px)}
    .choice.correct{background:linear-gradient(135deg,#DCEDC8,#A5D6A7); border-color:#43A047; color:#1B5E20}
    .choice.wrong{background:linear-gradient(135deg,#FFCDD2,#EF9A9A); border-color:#E53935; color:#B71C1C}

    .progress{height:14px; background:#eee; border-radius:8px; overflow:hidden; margin-top:12px}
    .progress>div{height:100%; width:0%; background:linear-gradient(90deg,var(--c2),var(--c1))}
    .next-btn{background:linear-gradient(90deg,var(--c4),var(--c5)); border:none; color:#fff; padding:10px 16px;
      border-radius:12px; font-weight:900; margin-top:12px; cursor:pointer}
    .home-btn{background:#fff; border:2px dashed var(--c4); padding:8px 12px; border-radius:12px; cursor:pointer; margin-top:12px}

    .rec-row{display:flex; gap:8px; align-items:center; justify-content:center; margin-top:10px}
    .rec-btn{padding:8px 12px; border-radius:10px; border:none; font-weight:800; cursor:pointer}
    .rec-indicator{font-size:13px; color:#666; margin-left:6px}
    .transcript{font-weight:800; padding:6px 8px; border-radius:8px; border:2px solid transparent;
      margin-left:10px; min-width:160px; text-align:center}
    .rec-play-wrap{display:flex; flex-direction:column; align-items:center; margin-top:10px}

    @media (max-width:760px){
      .game-content{flex-direction:column}
      .char-box .word{font-size:48px}
    }

    #end{display:none; text-align:center}
    .end-card{padding:20px; border-radius:16px; background:linear-gradient(135deg,#FFF3E0,#FFE0B2)}
    .score-big{font-size:36px; font-weight:900; color:var(--c1); margin:10px 0}
    .encourage{margin-top:12px; font-size:18px; font-weight:900; color:var(--c5)}
    footer{margin-top:16px; text-align:center; color:#999; font-weight:700}

    /* å¥–åŠ±åŠ¨ç”» */
    .reward-animation {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      background:rgba(255,255,255,0.9);
      z-index:1000;
      animation:fadeInOut 3s forwards;
    }
    .reward-text {
      font-size:42px;
      font-weight:900;
      color:var(--c1);
      text-shadow:2px 2px 4px rgba(0,0,0,0.2);
      margin-bottom:20px;
      animation:bounce 1s infinite alternate;
    }
    .reward-emoji {
      font-size:80px;
      animation:spin 2s infinite;
    }
    @keyframes fadeInOut {
      0% { opacity:0; }
      20% { opacity:1; }
      80% { opacity:1; }
      100% { opacity:0; visibility:hidden; }
    }
    @keyframes bounce {
      from { transform:scale(1); }
      to { transform:scale(1.1); }
    }
    @keyframes spin {
      from { transform:rotate(0deg); }
      to { transform:rotate(360deg); }
    }

    /* ç»“ç®—åŠ¨ç”» */
    .celebration {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      pointer-events:none;
      z-index:999;
    }
    .confetti {
      position:absolute;
      width:10px;
      height:20px;
      background:var(--c1);
      top:-20px;
      animation:fall linear forwards;
    }
    .confetti:nth-child(2n) { background:var(--c2); }
    .confetti:nth-child(3n) { background:var(--c3); }
    .confetti:nth-child(4n) { background:var(--c4); }
    .confetti:nth-child(5n) { background:var(--c5); }
    @keyframes fall {
      to {
        transform:translateY(100vh) rotate(360deg);
        opacity:0;
      }
    }
    .firework {
      position:absolute;
      width:5px;
      height:5px;
      border-radius:50%;
      box-shadow:0 0 10px 2px;
      animation:explode 1s forwards;
    }
    @keyframes explode {
      0% {
        transform:scale(1);
        opacity:1;
      }
      100% {
        transform:scale(20);
        opacity:0;
      }
    }
    .superman {
  position: fixed;
  top: 50%; /* å‚ç›´å±…ä¸­ */
  left: -100px; /* åˆå§‹ä½ç½®åœ¨å±å¹•å·¦ä¾§å¤– */
  transform: translateY(-50%); /* å‚ç›´å±…ä¸­å¯¹é½ */
  font-size: 80px;
  animation: flyRight 3s forwards; /* ä½¿ç”¨æ–°çš„ä»å·¦åˆ°å³åŠ¨ç”» */
  z-index: 1001;
}
@keyframes flyRight {
  0% {
    left: -100px; /* å·¦ä¾§å¤–éƒ¨å¼€å§‹ */
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    left: 100vw; /* é£åˆ°å³ä¾§å¤–éƒ¨ */
    opacity: 0;
  }
}
  </style>
</head>
<body>
  <div class="animal-emoji animal-1">ğŸ°</div>
  <div class="animal-emoji animal-2">ğŸ¯</div>
  <div class="animal-emoji animal-3">ğŸµ</div>
  <div class="animal-emoji animal-4">ğŸ¶</div>
  <div class="animal-emoji animal-5">ğŸ¦</div>
  <div class="animal-emoji animal-6">ğŸ˜</div>

  <div class="wrap" role="application" aria-label="è¯è¯­æ‹¼è¯»ç»ƒä¹ ">
    <header>
      <div class="logo">è¯</div>
      <h1>è¯è¯­æ‹¼è¯»ç»ƒä¹ </h1>
    </header>

    <main>
      <!-- HOME -->
      <section id="home">
        <div class="card">
          <div style="font-weight:900">è¯·é€‰æ‹©å¹´çº§</div>
          <div class="grade-selects" id="grade-selects">
            <div class="grade-btn" data-grade="1">ä¸€å¹´çº§<br><span style="font-size:13px;opacity:.9">æš‚ç©º</span></div>
            <div class="grade-btn" data-grade="2">äºŒå¹´çº§<br><span style="font-size:13px;opacity:.9">æš‚ç©º</span></div>
            <div class="grade-btn" data-grade="3">ä¸‰å¹´çº§<br><span style="font-size:13px;opacity:.9">æš‚ç©º</span></div>
            <div class="grade-btn" data-grade="4">å››å¹´çº§<br><span style="font-size:13px;opacity:.9">å·²åŠ è½½è¯è¯­</span></div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:900">é¢˜ç›®æ•°é‡</div>
          <div class="num-select" id="num-select">
            <div class="num-btn" data-num="10">10</div>
            <div class="num-btn" data-num="20">20</div>
            <div class="num-btn" data-num="30">30</div>
            <div class="num-btn" data-num="40">40</div>
            <div class="num-btn selected" data-num="all">å…¨éƒ¨</div>
          </div>
          <div class="custom-box">
            <label for="custom-num" style="font-weight:800">è‡ªå®šä¹‰ï¼š</label>
            <input id="custom-num" class="custom-input" type="number" min="1" placeholder="æ•°é‡">
            <div style="font-size:13px;color:#666">ï¼ˆè¶…è¿‡æœ€å¤§å€¼ä¼šè‡ªåŠ¨å–æœ€å¤§ï¼‰</div>
          </div>
        </div>

        <button id="start-game" class="start-btn">å¼€å§‹ç»ƒä¹ </button>
      </section>

      <!-- GAME -->
      <section id="game" aria-live="polite">
        <div class="topbar" style="display:flex;justify-content:space-between;">
          <div id="game-grade" style="font-weight:900">å››å¹´çº§</div>
          <div id="q-count" style="font-weight:900">0 / 0</div>
        </div>

        <div class="game-content">
          <div class="char-box">
            <span class="word" id="word-display">è¯è¯­</span>
            <div class="meta" id="meta-line">ï¼ˆè‹±æ–‡é‡Šä¹‰ï¼‰</div>
            <div style="margin-top:6px">
              <button id="play-sound" class="play-btn">æ’­æ”¾é¢˜å¹²éŸ³</button>
            </div>

            <div class="rec-row">
              <button id="rec-btn" class="rec-btn" style="background:linear-gradient(90deg,var(--c1),var(--c2));color:#fff">å½•éŸ³</button>
              <button id="stop-rec-btn" class="rec-btn" style="background:linear-gradient(90deg,var(--c3),var(--c4));color:#fff;display:none">åœæ­¢</button>
              <span id="rec-status" class="rec-indicator">ï¼ˆæœªå½•éŸ³ï¼‰</span>
              <div id="transcript" class="transcript" title="è¯†åˆ«ç»“æœæ˜¾ç¤ºåœ¨è¿™é‡Œ">ï¼ˆè¯†åˆ«ç»“æœï¼‰</div>
            </div>

            <div class="rec-play-wrap">
              <audio id="user-rec-audio" controls style="display:none;margin-top:8px"></audio>
            </div>
          </div>

          <div class="choices" id="choices"></div>
        </div>

        <div class="progress"><div id="progress-bar"></div></div>
        <div id="score-text" style="margin-top:10px;font-weight:900">å¾—åˆ†ï¼š0</div>

        <div style="display:flex;gap:10px;margin-top:12px;justify-content:center;">
          <button id="next-btn" class="next-btn" style="display:none">ä¸‹ä¸€é¢˜</button>
          <button id="quit-btn" class="home-btn">ç»“æŸå¹¶è¿”å›</button>
        </div>
      </section>

      <!-- END -->
      <section id="end">
        <div class="end-card">
          <div style="font-weight:900">æœ¬è½®å®Œæˆ</div>
          <div class="score-big" id="final-score">0 / 0</div>
          <div class="encourage" id="encourage"></div>
          <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
            <button id="retry-btn" class="start-btn">å†æ¥ä¸€æ¬¡</button>
            <button id="back-home-btn" class="home-btn">è¿”å›é¦–é¡µ</button>
          </div>
        </div>
      </section>
    </main>

    <footer>å¿«ä¹å­¦è¯è¯­ ğŸˆ</footer>
  </div>

  <audio id="audio" preload="auto" style="display:none"></audio>

  <script>
    const gradeWords = {1:[],2:[],3:[],4:[
      "ä¸ªäºº","ç¤¾ä¼š","è§’è‰²","ä»£è¡¨","å…´è¶£","è§’è‰²","å®¶åº­","å­¦æ ¡","æ´»åŠ¨","è€å¸ˆ",
      "å¿ƒæƒ…","åšé¥­","è¡£æœ","é£Ÿç‰©","å”±æ­Œ","çœ‹ç”µå½±","è¯»ä¹¦","æ—¶å€™","äº²è¿‘","ä¸¾æ‰‹",
      "å¤§ç¬‘","åˆ†äº«","æ¯”èµ›","å‘¨æœ«","è‡ªå·±"
    ]};

    const pinyinMap = {
      "ä¸ª":{pinyinBase:"ge",tone:4},"äºº":{pinyinBase:"ren",tone:2},"ç¤¾":{pinyinBase:"she",tone:4},"ä¼š":{pinyinBase:"hui",tone:4},
      "è§’":{pinyinBase:"jue",tone:2},"è‰²":{pinyinBase:"se",tone:4},"ä»£":{pinyinBase:"dai",tone:4},"è¡¨":{pinyinBase:"biao",tone:3},
      "å…´":{pinyinBase:"xing",tone:4},"è¶£":{pinyinBase:"qu",tone:4},"å®¶":{pinyinBase:"jia",tone:1},"åº­":{pinyinBase:"ting",tone:2},
      "å­¦":{pinyinBase:"xue",tone:2},"æ ¡":{pinyinBase:"xiao",tone:4},"æ´»":{pinyinBase:"huo",tone:2},"åŠ¨":{pinyinBase:"dong",tone:4},
      "è€":{pinyinBase:"lao",tone:3},"å¸ˆ":{pinyinBase:"shi",tone:1},"å¿ƒ":{pinyinBase:"xin",tone:1},"æƒ…":{pinyinBase:"qing",tone:2},
      "åš":{pinyinBase:"zuo",tone:4},"é¥­":{pinyinBase:"fan",tone:4},"è¡£":{pinyinBase:"yi",tone:1},"æœ":{pinyinBase:"fu",tone:2},
      "é£Ÿ":{pinyinBase:"shi",tone:2},"ç‰©":{pinyinBase:"wu",tone:4},"å”±":{pinyinBase:"chang",tone:4},"æ­Œ":{pinyinBase:"ge",tone:1},
      "çœ‹":{pinyinBase:"kan",tone:4},"ç”µ":{pinyinBase:"dian",tone:4},"å½±":{pinyinBase:"ying",tone:3},"å¤§":{pinyinBase:"da",tone:4},
      "è¯»":{pinyinBase:"du",tone:2},"ä¹¦":{pinyinBase:"shu",tone:1},"æ—¶":{pinyinBase:"shi",tone:2},"å€™":{pinyinBase:"hou",tone:4},
      "äº²":{pinyinBase:"qin",tone:1},"è¿‘":{pinyinBase:"jin",tone:4},"ä¸¾":{pinyinBase:"ju",tone:2},"æ‰‹":{pinyinBase:"shou",tone:3},
      "ç¬‘":{pinyinBase:"xiao",tone:4},"åˆ†":{pinyinBase:"fen",tone:1},"äº«":{pinyinBase:"xiang",tone:3},
      "æ¯”":{pinyinBase:"bi",tone:3},"èµ›":{pinyinBase:"sai",tone:4},"å‘¨":{pinyinBase:"zhou",tone:1},"æœ«":{pinyinBase:"mo",tone:4},
      "è‡ª":{pinyinBase:"zi",tone:4},"å·±":{pinyinBase:"ji",tone:3}
    };

    const lexiconWords = {
      "ä¸ªäºº":"personal; individual","ç¤¾ä¼š":"society; social","è§’è‰²":"role; character",
      "ä»£è¡¨":"representative; to represent","å…´è¶£":"interest; hobby","å®¶åº­":"family; household",
      "å­¦æ ¡":"school","æ´»åŠ¨":"activity; event","è€å¸ˆ":"teacher","å¿ƒæƒ…":"mood; feeling",
      "åšé¥­":"to cook; cooking","è¡£æœ":"clothes; clothing","é£Ÿç‰©":"food","å”±æ­Œ":"to sing; singing",
      "çœ‹ç”µå½±":"to watch a movie; watching movies","è¯»ä¹¦":"to read; studying","æ—¶å€™":"time; moment",
      "äº²è¿‘":"intimate; close","ä¸¾æ‰‹":"to raise one's hand","å¤§ç¬‘":"laugh",
      "åˆ†äº«":"to share","æ¯”èµ›":"competition; match","å‘¨æœ«":"weekend","è‡ªå·±":"oneself; self"
    };

    const gradeBtns = document.querySelectorAll(".grade-btn");
    const numBtns = document.querySelectorAll(".num-btn");
    const customInput = document.getElementById("custom-num");
    const startBtn = document.getElementById("start-game");
    const homeSection = document.getElementById("home");
    const gameSection = document.getElementById("game");
    const endSection = document.getElementById("end");
    const gameGradeEl = document.getElementById("game-grade");
    const qCountEl = document.getElementById("q-count");
    const wordDisplay = document.getElementById("word-display");
    const metaLineEl = document.getElementById("meta-line");
    const playSoundBtn = document.getElementById("play-sound");
    const choicesEl = document.getElementById("choices");
    const nextBtn = document.getElementById("next-btn");
    const quitBtn = document.getElementById("quit-btn");
    const progressBar = document.getElementById("progress-bar");
    const scoreText = document.getElementById("score-text");
    const finalScoreEl = document.getElementById("final-score");
    const encourageEl = document.getElementById("encourage");
    const retryBtn = document.getElementById("retry-btn");
    const backHomeBtn = document.getElementById("back-home-btn");
    const audioEl = document.getElementById("audio");
    const recBtn = document.getElementById("rec-btn");
    const stopRecBtn = document.getElementById("stop-rec-btn");
    const recStatus = document.getElementById("rec-status");
    const transcriptEl = document.getElementById("transcript");
    const userRecAudio = document.getElementById("user-rec-audio");

    let selectedGrade = 4, selectedNum = "all", customNum = null;
    let pool = [], order = [], cur = 0, total = 0, score = 0;
    let choiceSelected = false, recDone = false, recCorrect = false;
    let mediaStream = null, mediaRecorder = null, recordedChunks = [], recognition = null;
    let consecutiveCorrect = 0;
    let isChoiceCorrect = false;

    function shuffleArray(a) {
      const arr = a.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function buildPoolForGrade(g) {
      const list = gradeWords[g] || [];
      return list.map(w => {
        const syllables = [];
        for (const ch of w) {
          const info = pinyinMap[ch];
          if (info) syllables.push({char:ch, pinyinBase:info.pinyinBase, tone:info.tone || 0});
          else syllables.push({char:ch, pinyinBase:ch, tone:0});
        }
        return {word:w, syllables};
      });
    }

    function markTone(syllable, tone) {
      if (!tone || tone === 0) return syllable;
      let s = syllable.replace(/v/g,'Ã¼');
      const toneMap = {a:['Ä','Ã¡','Ç','Ã '],o:['Å','Ã³','Ç’','Ã²'],e:['Ä“','Ã©','Ä›','Ã¨'],
                       i:['Ä«','Ã­','Ç','Ã¬'],u:['Å«','Ãº','Ç”','Ã¹'],Ã¼:['Ç–','Ç˜','Çš','Çœ']};
      const lower = s.toLowerCase();
      let targetIndex = -1;
      if (lower.includes('iu')) targetIndex = lower.indexOf('iu') + 1;
      else if (lower.includes('ui')) targetIndex = lower.indexOf('ui') + 1;
      else {
        const order = ['a','o','e','i','u','Ã¼'];
        for (let ch of order) { const idx = lower.indexOf(ch); if (idx !== -1) { targetIndex = idx; break; } }
      }
      if (targetIndex === -1) return s;
      const ch = s[targetIndex].toLowerCase();
      const marks = toneMap[ch];
      if (!marks) return s;
      const mark = marks[tone - 1];
      s = s.substring(0, targetIndex) + mark + s.substring(targetIndex + 1);
      if (['j','q','x'].includes(s[0]) && s.includes('Ã¼')) s = s.replace('Ã¼','u');
      return s;
    }

    function buildWordPinyinMarked(syllables) {
      return syllables.map(s => markTone(s.pinyinBase, s.tone)).join(' ');
    }

    function buildBaiduTtsTexParam(syllables) {
      return syllables.map(s => `${s.char}(${s.pinyinBase}${s.tone || ''})`).join('');
    }

    function playBaiduTtsForWord(syllables) {
      const tex = buildBaiduTtsTexParam(syllables);
      const url = `https://tts.baidu.com/text2audio?tex=${encodeURIComponent(tex)}&cuid=dict&lan=ZH&ctp=2&pdt=30&vol=9`;
      audioEl.src = url; audioEl.play().catch(()=>{});
    }

    function generatePinyinOptions(syllables) {
      const correct = buildWordPinyinMarked(syllables);
      const variants = new Set([correct]);
      const similarInitials = {b:["p","d"],p:["b","t"],m:["n","f"],f:["m","h"],d:["t","b"],t:["d","p"],
        n:["l","m"],l:["n","r"],g:["k","h"],k:["g","h"],h:["k","g"],j:["q","x"],q:["j","x"],x:["j","q"],
        zh:["ch","sh","z"],ch:["zh","sh","c"],sh:["ch","zh","s"],r:["l","y"],z:["c","s"],c:["z","s"],
        s:["z","c"],y:["j","w"],w:["y","j"]};
      const similarFinals = {a:["ai","an"],o:["ou","ong"],e:["ei","en"],i:["ie","in"],u:["ui","un"],Ã¼:["Ã¼e","un"]};

      function perturbSyllable(item) {
        const copy = {...item};
        const r = Math.random();
        if (r < 0.4) {
          let newTone = copy.tone;
          while (newTone === copy.tone) newTone = Math.floor(Math.random() * 4) + 1;
          copy.tone = newTone;
        } else if (r < 0.7) {
          const base = copy.pinyinBase;
          const m = base.match(/^(zh|ch|sh|[bpmfdtnlgkhjqxrzcs])/);
          if (m) {
            const init = m[0];
            const sim = similarInitials[init] || [];
            if (sim.length) copy.pinyinBase = sim[Math.floor(Math.random()*sim.length)] + base.slice(init.length);
          }
        } else {
          const base = copy.pinyinBase;
          for (const f in similarFinals) {
            if (base.endsWith(f)) {
              const sim = similarFinals[f];
              if (sim.length) copy.pinyinBase = base.slice(0,-f.length) + sim[Math.floor(Math.random()*sim.length)];
              break;
            }
          }
        }
        return copy;
      }

      while (variants.size < 4) {
        const copy = syllables.map(s => ({...s}));
        const idx = Math.floor(Math.random() * copy.length);
        copy[idx] = perturbSyllable(copy[idx]);
        const cand = buildWordPinyinMarked(copy);
        if (cand !== correct) variants.add(cand);
      }
      return shuffleArray(Array.from(variants));
    }

    function startGame() {
      pool = buildPoolForGrade(selectedGrade);
      let n = pool.length;
      if (selectedNum !== "all") {
        const cap = selectedNum === "custom" ? customNum : parseInt(selectedNum);
        n = Math.min(cap || n, pool.length);
      }
      if (n < pool.length) pool = shuffleArray(pool).slice(0,n);
      total = pool.length; score = 0; cur = 0;
      order = shuffleArray(Array.from(Array(total).keys()));

      homeSection.style.display = "none";
      gameSection.style.display = "block";
      endSection.style.display = "none";
      gameGradeEl.textContent = `å››å¹´çº§`;
      qCountEl.textContent = `${cur+1} / ${total}`;
      scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
      progressBar.style.width = `0%`;
      showQuestion(cur);
    }

    function showQuestion(index) {
      choiceSelected = false; recDone = false; recCorrect = false;
      isChoiceCorrect = false;
      nextBtn.style.display = "none";
      transcriptEl.textContent = "ï¼ˆè¯†åˆ«ç»“æœï¼‰";
      transcriptEl.style.borderColor = transcriptEl.style.background = transcriptEl.style.color = "";
      transcriptEl.title = "è¯†åˆ«ç»“æœæ˜¾ç¤ºåœ¨è¿™é‡Œ";
      userRecAudio.style.display = "none"; userRecAudio.src = "";
      recStatus.textContent = "ï¼ˆæœªå½•éŸ³ï¼‰";

      // é‡ç½®é€‰é¡¹åŒºï¼ˆå…³é”®ï¼ï¼‰
      choicesEl.style.display = "flex";
      choicesEl.style.opacity = "1";
      choicesEl.innerHTML = "";

      const q = pool[order[index]];
      wordDisplay.textContent = q.word;
      metaLineEl.textContent = lexiconWords[q.word] || "ï¼ˆè‹±æ–‡é‡Šä¹‰æš‚ç¼ºï¼‰";
      qCountEl.textContent = `${index+1} / ${total}`;
      progressBar.style.width = Math.round((index/total)*100) + "%";

      const opts = generatePinyinOptions(q.syllables);
      for (const text of opts) {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = text;
        btn.addEventListener("click", ()=> {
          document.querySelectorAll(".choice").forEach(b => b.disabled = true);
          const correctStr = buildWordPinyinMarked(q.syllables);
          if (text === correctStr) {
            btn.classList.add("correct");
            isChoiceCorrect = true;
            score++; scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
          } else {
            btn.classList.add("wrong");
            document.querySelectorAll(".choice").forEach(b => {
              if (b.textContent === correctStr) b.classList.add("correct");
            });
          }
          choiceSelected = true;
          checkIfReadyToNext();

        // å»¶è¿Ÿ2ç§’åï¼Œä»…æ¸…ç©ºé€‰é¡¹å†…å®¹ï¼Œä¸å†æ·¡å‡ºæˆ–éšè—
fadeTimer = setTimeout(() => {
  choicesEl.innerHTML = ""; // æ¸…ç©ºæ—§é¢˜é€‰é¡¹
}, 2000);

// å»¶è¿Ÿåæ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›å…¥ä¸‹ä¸€é¢˜
setTimeout(() => {
  checkIfReadyToNext();
}, 2000);

          checkIfReadyToNext();
        });
        choicesEl.appendChild(btn);
      }

      playBaiduTtsForWord(q.syllables);
    }

    function checkIfReadyToNext() {
      if (choiceSelected && recDone && recCorrect) {
        nextBtn.style.display = "inline-block";
      }
    }

    async function ensureMediaStream() {
      if (mediaStream) return mediaStream;
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      return mediaStream;
    }

    function createRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return null;
      const rec = new SpeechRecognition();
      rec.lang = 'zh-CN'; rec.interimResults = false; rec.maxAlternatives = 1;
      return rec;
    }

    recBtn.addEventListener("click", async ()=>{
      try {
        const stream = await ensureMediaStream();
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => e.data.size && recordedChunks.push(e.data);
        mediaRecorder.onstart = () => {
          recStatus.textContent = "ï¼ˆæ­£åœ¨å½•éŸ³ï¼‰";
          recBtn.style.display = "none"; stopRecBtn.style.display = "inline-block";
        };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, {type:'audio/webm'});
          userRecAudio.src = URL.createObjectURL(blob);
          userRecAudio.style.display = "inline-block";
          recStatus.textContent = "ï¼ˆå·²å½•éŸ³ï¼‰";
          recBtn.style.display = "inline-block"; stopRecBtn.style.display = "none";
          recDone = true; checkIfReadyToNext();
        };
        mediaRecorder.start();
      } catch (e) { alert("æ— æ³•å½•éŸ³ï¼š" + e.message); }

      if (!recognition) recognition = createRecognition();
      if (!recognition) {
        transcriptEl.textContent = "ï¼ˆæµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼‰";
        transcriptEl.style.color = "#B71C1C";
        return;
      }
      transcriptEl.textContent = "ï¼ˆè¯†åˆ«ä¸­...ï¼‰";
      const q = pool[order[cur]];
      recognition.onresult = e => {
        const text = Array.from(e.results).map(r=>r[0].transcript).join('');
        transcriptEl.textContent = text || "ï¼ˆæœªè¯†åˆ«åˆ°ï¼‰";
        const normalized = text.replace(/\s+/g,'');
        const ok = q.word.split('').every(ch => normalized.includes(ch));
        if (ok) {
          transcriptEl.style.borderColor = "#4CAF50";
          transcriptEl.style.background = "#E8F5E9";
          transcriptEl.style.color = "#1B5E20";
          recCorrect = true;
        } else {
          transcriptEl.style.borderColor = "#E53935";
          transcriptEl.style.background = "#FFEBEE";
          transcriptEl.style.color = "#B71C1C";
        }
        checkIfReadyToNext();
      };
      recognition.onerror = () => {
        transcriptEl.textContent = "ï¼ˆè¯†åˆ«å‡ºé”™ï¼‰";
        transcriptEl.style.borderColor = "#E53935";
        transcriptEl.style.background = "#FFEBEE";
      };
      recognition.start();
    });

    stopRecBtn.addEventListener("click", ()=>{
      if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
      if (recognition) recognition.stop();
    });

    playSoundBtn.addEventListener("click", () => playBaiduTtsForWord(pool[order[cur]].syllables));

    nextBtn.addEventListener("click", () => { 
      if (isChoiceCorrect) {
        consecutiveCorrect++;
        if (consecutiveCorrect >= 5) {
          showRewardAnimation();
          consecutiveCorrect = 0;
        }
      } else {
        consecutiveCorrect = 0;
      }
      cur++; cur < total ? showQuestion(cur) : finishRound(); 
    });
    quitBtn.addEventListener("click", finishRound);

    function finishRound() {
      gameSection.style.display = "none"; endSection.style.display = "block";
      const pct = Math.round((score/total)*100);
      finalScoreEl.textContent = `${score} / ${total} = ${pct}%`;

      // è®¡ç®—Dojoåˆ†
      let dojoPoints = 0;
      let dojoText = "";
      
      if (pct >= 60 && pct < 70) {
        dojoPoints = 1;
        dojoText = "æ­å–œè·å¾—1ä¸ªDojoåˆ†";
      } else if (pct >= 70 && pct < 80) {
        dojoPoints = 2;
        dojoText = "æ­å–œè·å¾—2ä¸ªDojoåˆ†";
      } else if (pct >= 80 && pct < 90) {
        dojoPoints = 3;
        dojoText = "æ­å–œè·å¾—3ä¸ªDojoåˆ†";
      } else if (pct >= 90 && pct < 100) {
        dojoPoints = 4;
        dojoText = "æ­å–œè·å¾—4ä¸ªDojoåˆ†";
      } else if (pct === 100) {
        dojoPoints = 5;
        dojoText = "æ­å–œè·å¾—5ä¸ªDojoåˆ†";
      }

      // æ ¹æ®åˆ†æ•°è®¾ç½®ä¸åŒé¼“åŠ±è¯­
      let phrases;
      if (pct >= 90) {
        phrases = [
          "å¤ªå‡ºè‰²äº†ï¼ç»§ç»­åŠ æ²¹ ğŸ’ª",
          "å¤ªæ£’äº†ï¼å†æŒ‘æˆ˜ä¸€æ¬¡å§ ğŸŒŸ",
          "å®Œç¾ï¼ç»§ç»­ä¿æŒå¥½ä¹ æƒ¯ ğŸ˜Š",
          "æƒŠäººçš„è¿›æ­¥ï¼Œç»§ç»­ç»ƒå°±æ›´æ£’ï¼ğŸ‰",
          "å¤ªä¼˜ç§€äº†ï¼ä½ çš„å‘éŸ³å ªç§°å®Œç¾ï¼ğŸ‘"
        ];
      } else if (pct >= 70) {
        phrases = [
          "åšå¾—å¾ˆå¥½ï¼ç»§ç»­åŠ æ²¹ ğŸ’ª",
          "å¾ˆä¸é”™ï¼å†æŒ‘æˆ˜ä¸€æ¬¡å§ ğŸŒŸ",
          "å®Œæˆå¾—å¾ˆæ£’ï¼Œç»§ç»­ä¿æŒå¥½ä¹ æƒ¯ ğŸ˜Š",
          "æœ‰æ˜æ˜¾è¿›æ­¥ï¼Œç»§ç»­ç»ƒå°±æ›´æ£’ï¼ğŸ‰",
          "è¡¨ç°ä¼˜ç§€ï¼ä½ çš„å‘éŸ³æ›´è¿›ä¸€æ­¥äº†ï¼ğŸ‘"
        ];
      } else if (pct >= 60) {
        phrases = [
          "æ­å–œè¿‡å…³ï¼ç»§ç»­åŠ æ²¹ ğŸ’ª",
          "åˆšå¥½åŠæ ¼ï¼Œå†æŒ‘æˆ˜ä¸€æ¬¡å§ ğŸŒŸ",
          "å®Œæˆäº†ç»ƒä¹ ï¼Œç»§ç»­ä¿æŒå¥½ä¹ æƒ¯ ğŸ˜Š",
          "æœ‰è¿›æ­¥ç©ºé—´ï¼Œç»§ç»­ç»ƒå°±æ›´æ£’ï¼ğŸ‰",
          "è¾¾åˆ°ç›®æ ‡äº†ï¼ä½ çš„å‘éŸ³è¿˜èƒ½æ›´å¥½ï¼ğŸ‘"
        ];
      } else {
        // ä½äº60åˆ†çš„é¼“åŠ±è¯­ï¼ˆéè¡¨æ‰¬ç±»ï¼‰
        phrases = [
          "åˆ«ç°å¿ƒï¼Œå¤šç»ƒä¹ ä¸€å®šèƒ½è¿›æ­¥ ğŸ’ª",
          "è¿™æ¬¡æ²¡å‘æŒ¥å¥½ï¼Œå†è¯•ä¸€æ¬¡å§ ğŸŒŸ",
          "æ‰¾åˆ°ä¸è¶³å°±æ˜¯è¿›æ­¥çš„å¼€å§‹ ğŸ˜Š",
          "ç»§ç»­åŠªåŠ›ï¼Œä¸‹æ¬¡ä¸€å®šä¼šæ›´æ£’ï¼ğŸ‰",
          "åŠ æ²¹ï¼å¤šå¬å¤šç»ƒå°±èƒ½æé«˜å‘éŸ³ï¼ğŸ‘"
        ];
      }
      
      const randomPhrase = phrases[Math.floor(Math.random()*phrases.length)];
      
      if (dojoText) {
        encourageEl.textContent = `${randomPhrase} ${dojoText}`;
      } else {
        encourageEl.textContent = randomPhrase;
      }

      if (pct >= 60) {
        showCelebrationAnimation(pct);
      }
    }

    // æ˜¾ç¤ºå¥–åŠ±åŠ¨ç”»
    function showRewardAnimation() {
      const phrases = [
        "å¤ªæ£’äº†ï¼è¿ç»­ç­”å¯¹5é¢˜ï¼ğŸ‰",
        "ä½ çœŸå‰å®³ï¼è¿ç»­ç­”å¯¹5é¢˜ï¼ğŸŒŸ",
        "å“‡ï¼è¿ç»­ç­”å¯¹5é¢˜ï¼å¤ªä¼˜ç§€äº†ï¼ğŸ’ª",
        "è¿ç»­ç­”å¯¹5é¢˜ï¼ä½ çœŸæ˜¯ä¸ªå­¦ä¹ å°èƒ½æ‰‹ï¼ğŸ‘",
        "ä¼˜ç§€ï¼è¿ç»­ç­”å¯¹5é¢˜ï¼ç»§ç»­ä¿æŒï¼ğŸš€"
      ];
      
      const rewardText = phrases[Math.floor(Math.random() * phrases.length)];
      
      const rewardDiv = document.createElement("div");
      rewardDiv.className = "reward-animation";
      rewardDiv.innerHTML = `
        <div class="reward-text">${rewardText}</div>
        <div class="reward-emoji">ğŸ‰</div>
      `;
      
      document.body.appendChild(rewardDiv);
      
      // 3ç§’åç§»é™¤åŠ¨ç”»
      setTimeout(() => {
        document.body.removeChild(rewardDiv);
      }, 3000);
    }

    // æ˜¾ç¤ºåº†ç¥åŠ¨ç”»
    function showCelebrationAnimation(percentage) {
      // åˆ›å»ºåº†ç¥å®¹å™¨
      const celebrationDiv = document.createElement("div");
      celebrationDiv.className = "celebration";
      document.body.appendChild(celebrationDiv);
      
      // åˆ›å»ºäº”å½©çº¸å±‘
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement("div");
        confetti.className = "confetti";
        confetti.style.left = Math.random() * 100 + "vw";
        confetti.style.animationDuration = (Math.random() * 3 + 2) + "s";
        confetti.style.animationDelay = Math.random() * 2 + "s";
        celebrationDiv.appendChild(confetti);
      }
      
      // åˆ›å»ºç¤¼èŠ±
      for (let i = 0; i < 10; i++) {
        setTimeout(() => {
          const firework = document.createElement("div");
          firework.className = "firework";
          firework.style.left = (Math.random() * 60 + 20) + "vw";
          firework.style.top = (Math.random() * 60 + 20) + "vh";
          firework.style.backgroundColor = [
            "#FF6F61", "#FFB74D", "#4DB6AC", "#64B5F6", "#BA68C8"
          ][Math.floor(Math.random() * 5)];
          celebrationDiv.appendChild(firework);
          
          setTimeout(() => {
            celebrationDiv.removeChild(firework);
          }, 1000);
        }, i * 300);
      }
      
      // åˆ†æ•°è¶Šé«˜æ˜¾ç¤ºçš„è¶…äººè¶Šå¤š
      const supermanCount = percentage >= 90 ? 3 : (percentage >= 70 ? 2 : 1);
      for (let i = 0; i < supermanCount; i++) {
        setTimeout(() => {
          const superman = document.createElement("div");
          superman.className = "superman";
          superman.textContent = "ğŸ¦¸";
          superman.style.top = (30 + i * 20) + '%';
          document.body.appendChild(superman);
          
          setTimeout(() => {
            if (superman.parentNode) {
              document.body.removeChild(superman);
            }
          }, 3000);
        }, i * 500);
      }
      
      // 5ç§’åç§»é™¤åº†ç¥åŠ¨ç”»
      setTimeout(() => {
        document.body.removeChild(celebrationDiv);
      }, 5000);
    }

    retryBtn.addEventListener("click", () => {
      score = 0; cur = 0; order = shuffleArray(order);
      endSection.style.display = "none"; gameSection.style.display = "block";
      qCountEl.textContent = `${cur+1} / ${total}`;
      scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
      progressBar.style.width = "0%";
      showQuestion(0);
    });
    backHomeBtn.addEventListener("click", () => {
      endSection.style.display = "none"; gameSection.style.display = "none"; homeSection.style.display = "block";
    });

    gradeBtns.forEach(b=>b.addEventListener("click",()=>{gradeBtns.forEach(x=>x.classList.remove("selected"));b.classList.add("selected");selectedGrade=+b.dataset.grade;}));
    numBtns.forEach(b=>b.addEventListener("click",()=>{numBtns.forEach(x=>x.classList.remove("selected"));b.classList.add("selected");selectedNum=b.dataset.num;customInput.value="";}));
    customInput.addEventListener("input",()=>{const v=+customInput.value;if(v>0){numBtns.forEach(x=>x.classList.remove("selected"));selectedNum="custom";customNum=v;}});
    startBtn.addEventListener("click", startGame);
    document.addEventListener("keydown", e => { if (e.key==="Enter" && homeSection.style.display!=="none") startBtn.click(); });

    document.querySelector('.grade-btn[data-grade="4"]').classList.add('selected');
    document.querySelector('.num-btn[data-num="all"]').classList.add('selected');

    window.addEventListener('beforeunload', () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
      if (recognition) recognition.abort();
    });
  </script>
</body>
</html>
