<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¯è¯­æ‹¼è¯»ç»ƒä¹ </title>
  <style>
    :root{
      --c1:#FF6F61; --c2:#FFB74D; --c3:#4DB6AC; --c4:#64B5F6; --c5:#BA68C8;
      --bg1:#FFF3E0; --bg2:#E1F5FE;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Comic Sans MS","Helvetica Neue",Arial,"PingFang SC",sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2),#F3E5F5);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
      overflow-x:hidden;
    }
    .wrap{
      width:100%; max-width:980px; background:#fff; border-radius:18px;
      padding:18px; box-shadow:0 12px 40px rgba(0,0,0,0.12); position:relative; z-index:1;
    }
    header{display:flex; align-items:center; gap:12px}
    .logo{width:84px; height:84px; border-radius:18px;
      background:conic-gradient(from 45deg,var(--c1),var(--c2),var(--c3),var(--c4),var(--c5),var(--c1));
      display:flex; align-items:center; justify-content:center; color:#fff; font-size:40px; font-weight:900;
      box-shadow:0 8px 26px rgba(0,0,0,0.18)}
    h1{margin:0; font-size:24px; color:var(--c1)}
    main{margin-top:14px}

    #home{display:block}
    .card{background:#fff; border-radius:14px; padding:14px; box-shadow:0 8px 22px rgba(0,0,0,0.06); margin-bottom:14px}
    .grade-selects{display:flex; gap:12px; flex-wrap:wrap; margin-top:12px}
    .grade-btn{flex:1; min-width:120px; padding:14px; border-radius:12px; font-weight:900;
      background:linear-gradient(135deg,var(--c2),var(--c1)); color:#fff; text-align:center; cursor:pointer; transition:.15s}
    .grade-btn.selected{outline:5px solid #64B5F6; transform:translateY(-4px)}
    .num-select{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .num-btn{padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer;
      background:linear-gradient(135deg,var(--c3),var(--c4)); color:#fff}
    .num-btn.selected{outline:4px solid #FFB74D; transform:scale(1.03)}
    .custom-box{display:flex; align-items:center; gap:8px; margin-top:10px}
    .custom-input{width:90px; padding:8px; border:3px solid var(--c4); border-radius:10px; text-align:center; font-weight:700}
    .start-btn{background:linear-gradient(90deg,var(--c1),var(--c2)); border:none; color:#fff;
      padding:14px 20px; border-radius:14px; font-weight:900; font-size:16px; cursor:pointer;
      box-shadow:0 8px 28px rgba(0,0,0,0.18); margin-top:14px}

    #game{display:none; position:relative}
    .animal-emoji{position:fixed; font-size:40px; opacity:0.5; z-index:0; pointer-events:none}
    .animal-1{top:6%; left:17%} .animal-2{top:8%; right:12%} .animal-3{bottom:15%; left:5%}
    .animal-4{bottom:12%; right:8%} .animal-5{top:40%; left:3%} .animal-6{top:55%; right:5%}

    .game-content{display:flex; width:100%; gap:20px; margin:14px 0; position:relative; z-index:1}
    .char-box{flex:1; text-align:center; padding:10px}
    .char-box .word{font-size:72px; font-weight:900; color:var(--c1)}
    .meta{font-size:16px; margin-top:6px; color:#333}
    .play-btn{margin-top:8px; padding:8px 14px; border:none; border-radius:12px;
      background:linear-gradient(90deg,var(--c3),var(--c4)); color:#fff; font-weight:800; cursor:pointer}

    .choices{flex:1; display:flex; flex-direction:column; gap:12px; margin-top:14px;
      transition:opacity 0.6s ease}
    .choice{padding:16px; border-radius:14px; font-weight:900; font-size:22px; cursor:pointer;
      background:linear-gradient(135deg,#FFFDE7,#FFF9C4); border:3px solid rgba(0,0,0,0.03); transition:.12s;
      text-align:center}
    .choice:hover{transform:translateY(-4px)}
    .choice.correct{background:linear-gradient(135deg,#DCEDC8,#A5D6A7); border-color:#43A047; color:#1B5E20}
    .choice.wrong{background:linear-gradient(135deg,#FFCDD2,#EF9A9A); border-color:#E53935; color:#B71C1C}

    .progress{height:14px; background:#eee; border-radius:8px; overflow:hidden; margin-top:12px}
    .progress>div{height:100%; width:0%; background:linear-gradient(90deg,var(--c2),var(--c1))}
    .next-btn{background:linear-gradient(90deg,var(--c4),var(--c5)); border:none; color:#fff; padding:10px 16px;
      border-radius:12px; font-weight:900; margin-top:12px; cursor:pointer}
    .home-btn{background:#fff; border:2px dashed var(--c4); padding:8px 12px; border-radius:12px; cursor:pointer; margin-top:12px}

    .rec-row{display:flex; gap:8px; align-items:center; justify-content:center; margin-top:10px}
    .rec-btn{padding:8px 12px; border-radius:10px; border:none; font-weight:800; cursor:pointer}
    .rec-indicator{font-size:13px; color:#666; margin-left:6px}
    .transcript{font-weight:800; padding:6px 8px; border-radius:8px; border:2px solid transparent;
      margin-left:10px; min-width:160px; text-align:center}
    .rec-play-wrap{display:flex; flex-direction:column; align-items:center; margin-top:10px}

    /* æ–°å¢æç¤ºæ ·å¼ */
    .stage-indicator {
      font-size: 16px;
      font-weight: bold;
      margin: 10px 0;
      padding: 8px;
      border-radius: 8px;
      background-color: #f0f7ff;
      color: #1976d2;
    }

    @media (max-width:760px){
      .game-content{flex-direction:column}
      .char-box .word{font-size:48px}
    }

    #end{display:none; text-align:center}
    .end-card{padding:20px; border-radius:16px; background:linear-gradient(135deg,#FFF3E0,#FFE0B2)}
    .score-big{font-size:36px; font-weight:900; color:var(--c1); margin:10px 0}
    .encourage{margin-top:12px; font-size:18px; font-weight:900; color:var(--c5)}
    footer{margin-top:16px; text-align:center; color:#999; font-weight:700}

    /* å¥–åŠ±åŠ¨ç”» */
    .reward-animation {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      background:rgba(255,255,255,0.9);
      z-index:1000;
      animation:fadeInOut 3s forwards;
    }
    .reward-text {
      font-size:42px;
      font-weight:900;
      color:var(--c1);
      text-shadow:2px 2px 4px rgba(0,0,0,0.2);
      margin-bottom:20px;
      animation:bounce 1s infinite alternate;
    }
    .reward-emoji {
      font-size:80px;
      animation:spin 2s infinite;
    }
    @keyframes fadeInOut {
      0% { opacity:0; }
      20% { opacity:1; }
      80% { opacity:1; }
      100% { opacity:0; visibility:hidden; }
    }
    @keyframes bounce {
      from { transform:scale(1); }
      to { transform:scale(1.1); }
    }
    @keyframes spin {
      from { transform:rotate(0deg); }
      to { transform:rotate(360deg); }
    }

    /* ç»“ç®—åŠ¨ç”» */
    .celebration {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      pointer-events:none;
      z-index:999;
    }
    .confetti {
      position:absolute;
      width:10px;
      height:20px;
      background:var(--c1);
      top:-20px;
      animation:fall linear forwards;
    }
    .confetti:nth-child(2n) { background:var(--c2); }
    .confetti:nth-child(3n) { background:var(--c3); }
    .confetti:nth-child(4n) { background:var(--c4); }
    .confetti:nth-child(5n) { background:var(--c5); }
    @keyframes fall {
      to {
        transform:translateY(100vh) rotate(360deg);
        opacity:0;
      }
    }
    .firework {
      position:absolute;
      width:5px;
      height:5px;
      border-radius:50%;
      box-shadow:0 0 10px 2px;
      animation:explode 1s forwards;
    }
    @keyframes explode {
      0% {
        transform:scale(1);
        opacity:1;
      }
      100% {
        transform:scale(20);
        opacity:0;
      }
    }
    .superman {
      position: fixed;
      top: 50%;
      left: -100px;
      transform: translateY(-50%);
      font-size: 80px;
      animation: flyRight 3s forwards;
      z-index: 1001;
    }
    @keyframes flyRight {
      0% {
        left: -100px;
        opacity: 0;
      }
      20% {
        opacity: 1;
      }
      100% {
        left: 100vw;
        opacity: 0;
      }
    }

    /* è¯è¯­é€‰æ‹©å¼¹çª—æ ·å¼ */
    #word-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 18px;
      padding: 20px;
      width: 95vw;
      max-width: 1000px;
      max-height: 90vh;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .grade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .word-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 5px;
      margin-bottom: 20px;
    }
    .word-btn {
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      padding: 5px;
    }
    .word-btn.selected {
      background: #FFB74D;
      color: white;
    }
    .select-all-btn {
      padding: 5px 10px;
      background: linear-gradient(90deg,var(--c3),var(--c4));
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .modal-footer {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="animal-emoji animal-1">ğŸ°</div>
  <div class="animal-emoji animal-2">ğŸ¯</div>
  <div class="animal-emoji animal-3">ğŸµ</div>
  <div class="animal-emoji animal-4">ğŸ¶</div>
  <div class="animal-emoji animal-5">ğŸ¦</div>
  <div class="animal-emoji animal-6">ğŸ˜</div>

  <div class="wrap" role="application" aria-label="è¯è¯­æ‹¼è¯»ç»ƒä¹ ">
    <header>
      <div class="logo">è¯</div>
      <h1>è¯è¯­æ‹¼è¯»ç»ƒä¹ </h1>
    </header>

    <main>
      <!-- HOME -->
      <section id="home">
        <div class="card">
          <div style="font-weight:900">è¯·é€‰æ‹©å¹´çº§</div>
          <div class="grade-selects" id="grade-selects">
            <div class="grade-btn" data-grade="1">ä¸€å¹´çº§<br><span style="font-size:13px;opacity:.9">æš‚ç©º</span></div>
            <div class="grade-btn" data-grade="2">äºŒå¹´çº§<br><span style="font-size:13px;opacity:.9">æš‚ç©º</span></div>
            <div class="grade-btn" data-grade="3">ä¸‰å¹´çº§<br><span style="font-size:13px;opacity:.9">æš‚ç©º</span></div>
            <div class="grade-btn" data-grade="4">å››å¹´çº§<br><span style="font-size:13px;opacity:.9">å·²åŠ è½½è¯è¯­</span></div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:900">é¢˜ç›®æ•°é‡</div>
          <div class="num-select" id="num-select">
            <div class="num-btn" data-num="10">10</div>
            <div class="num-btn" data-num="20">20</div>
            <div class="num-btn" data-num="30">30</div>
            <div class="num-btn" data-num="40">40</div>
            <div class="num-btn selected" data-num="all">å…¨éƒ¨</div>
          </div>
          <div class="custom-box">
            <label for="custom-num" style="font-weight:800">è‡ªå®šä¹‰ï¼š</label>
            <input id="custom-num" class="custom-input" type="number" min="1" placeholder="æ•°é‡">
            <div style="font-size:13px;color:#666">ï¼ˆè¶…è¿‡æœ€å¤§å€¼ä¼šè‡ªåŠ¨å–æœ€å¤§ï¼‰</div>
            <button id="select-words" style="background:linear-gradient(90deg,var(--c4),var(--c5));border:none;color:#fff;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer">é€‰æ‹©è¯è¯­</button>
          </div>
        </div>

        <button id="start-game" class="start-btn">å¼€å§‹ç»ƒä¹ </button>
      </section>

      <!-- GAME -->
      <section id="game" aria-live="polite">
        <div class="topbar" style="display:flex;justify-content:space-between;">
          <div id="game-grade" style="font-weight:900">å››å¹´çº§</div>
          <div id="q-count" style="font-weight:900">0 / 0</div>
        </div>

        <!-- æ–°å¢é˜¶æ®µæç¤º -->
        <div class="stage-indicator" id="stage-indicator">ç¬¬ä¸€é˜¶æ®µï¼šè¯·å…ˆæœ—è¯»è¯è¯­å¹¶å½•éŸ³éªŒè¯</div>

        <div class="game-content">
          <div class="char-box">
            <span class="word" id="word-display">è¯è¯­</span>
            <div class="meta" id="meta-line">ï¼ˆè‹±æ–‡é‡Šä¹‰ï¼‰</div>
            <div style="margin-top:6px">
              <button id="play-sound" class="play-btn">æ’­æ”¾è¯è¯­å‘éŸ³</button>
            </div>

            <div class="rec-row">
              <button id="rec-btn" class="rec-btn" style="background:linear-gradient(90deg,var(--c1),var(--c2));color:#fff">å¼€å§‹å½•éŸ³</button>
              <button id="stop-rec-btn" class="rec-btn" style="background:linear-gradient(90deg,var(--c3),var(--c4));color:#fff;display:none">åœæ­¢å½•éŸ³</button>
              <span id="rec-status" class="rec-indicator">ï¼ˆæœªå½•éŸ³ï¼‰</span>
              <div id="transcript" class="transcript" title="è¯†åˆ«ç»“æœæ˜¾ç¤ºåœ¨è¿™é‡Œ">ï¼ˆè¯†åˆ«ç»“æœï¼‰</div>
            </div>

            <div class="rec-play-wrap">
              <audio id="user-rec-audio" controls style="display:none;margin-top:8px"></audio>
            </div>
          </div>

          <div class="choices" id="choices"></div>
        </div>

        <div class="progress"><div id="progress-bar"></div></div>
        <div id="score-text" style="margin-top:10px;font-weight:900">å¾—åˆ†ï¼š0</div>

        <div style="display:flex;gap:10px;margin-top:12px;justify-content:center;">
          <button id="next-btn" class="next-btn" style="display:none">ä¸‹ä¸€é¢˜</button>
          <button id="quit-btn" class="home-btn">ç»“æŸå¹¶è¿”å›</button>
        </div>
      </section>

      <!-- END -->
      <section id="end">
        <div class="end-card">
          <div style="font-weight:900">æœ¬è½®å®Œæˆ</div>
          <div class="score-big" id="final-score">0 / 0</div>
          <div class="encourage" id="encourage"></div>
          <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
            <button id="retry-btn" class="start-btn">å†æ¥ä¸€æ¬¡</button>
            <button id="back-home-btn" class="home-btn">è¿”å›é¦–é¡µ</button>
          </div>
        </div>
      </section>
    </main>

    <footer>å¿«ä¹å­¦è¯è¯­ ğŸˆ</footer>
  </div>

  <!-- è¯è¯­é€‰æ‹©å¼¹çª— -->
  <div id="word-modal">
    <div class="modal-content">
      <div id="grade-sections"></div>
      <div class="modal-footer">
        <button id="start-custom" class="start-btn">å¼€å§‹ç»ƒä¹ </button>
        <button id="cancel-modal" class="home-btn">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <audio id="audio" preload="auto" style="display:none"></audio>

  <script>
    // ä¿®æ”¹ï¼šåœ¨gradeWordsä¸­å¢åŠ æ¯ä¸ªå­—çš„å£°æ¯(initial)å’ŒéŸµæ¯(final)ä¿¡æ¯
    const gradeWords = {
      1: [],
      2: [{word: "æˆ‘", pinyin: "wÇ’", syllables: [{char: "æˆ‘", pinyinBase: "wo", tone: 3, initial: "w", final: "o"}], english: "I; me"},{word: "å«", pinyin: "jiÃ o", syllables: [{char: "å«", pinyinBase: "jiao", tone: 4, initial: "j", final: "iao"}], english: "call; name"},{word: "ä¸‹é›¨", pinyin: "xiÃ  yÇ”", syllables: [{char: "ä¸‹", pinyinBase: "xia", tone: 4, initial: "x", final: "ia"}, {char: "é›¨", pinyinBase: "yu", tone: 3, initial: "", final:"Ã¼"}], english:"rain; raining"},{word: "ä¹¦åŒ…", pinyin: "shÅ« bÄo", syllables: [{char: "ä¹¦", pinyinBase: "shu", tone: 1, initial: "sh", final: "u"}, {char: "åŒ…", pinyinBase: "bao", tone: 1, initial: "b", final: "ao"}], english: "schoolbag; backpack"},{word: "æœ¬å­", pinyin: "bÄ›n zi", syllables: [{char: "æœ¬", pinyinBase: "ben", tone: 3, initial: "b", final: "en"}, {char: "å­", pinyinBase: "zi", tone: 5, initial: "z", final: "i"}], english: "notebook; book"},{word: "åŒå­¦", pinyin: "tÃ³ng xuÃ©", syllables: [{char: "åŒ", pinyinBase: "tong", tone: 2, initial: "t", final: "ong"}, {char: "å­¦", pinyinBase: "xue", tone: 2, initial: "x", final: "Ã¼e"}], english: "classmate; schoolmate"},{word: "å¹´çº§", pinyin: "niÃ¡n jÃ­", syllables: [{char: "å¹´", pinyinBase: "nian", tone: 2, initial: "n", final: "ian"}, {char: "çº§", pinyinBase: "ji", tone: 2, initial: "j", final: "i"}], english: "grade; year level"},{word: "é«˜å…´", pinyin: "gÄo xÃ¬ng", syllables: [{char: "é«˜", pinyinBase: "gao", tone: 1, initial: "g", final: "ao"}, {char: "å…´", pinyinBase: "xing", tone: 4, initial: "x", final: "ing"}], english: "happy; glad"},{word: "å›æ¥", pinyin: "huÃ­ lÃ¡i", syllables: [{char: "å›", pinyinBase: "hui", tone: 2, initial: "h", final: "ui"}, {char: "æ¥", pinyinBase: "lai", tone: 2, initial: "l", final: "ai"}], english: "come back; return"},{word: "å¼€å¿ƒ", pinyin: "kÄi xÄ«n", syllables: [{char: "å¼€", pinyinBase: "kai", tone: 1, initial: "k", final: "ai"}, {char: "å¿ƒ", pinyinBase: "xin", tone: 1, initial: "x", final: "in"}], english: "happy; joyful"},{word: "é•¿å¤§", pinyin: "zhÇng dÃ ", syllables: [{char: "é•¿", pinyinBase: "zhang", tone: 3, initial: "zh", final: "ang"}, {char: "å¤§", pinyinBase: "da", tone: 4, initial: "d", final: "a"}], english: "grow up; become an adult"},{word: "è¿˜æœ‰", pinyin: "hÃ¡i yÇ’u", syllables: [{char: "è¿˜", pinyinBase: "hai", tone: 2, initial: "h", final: "ai"}, {char: "æœ‰", pinyinBase: "you", tone: 3, initial: "y", final: "ou"}], english: "still have; in addition"}],
      3: [{word: "å›½å®¶", pinyin: "guÃ³ jiÄ", syllables: [{char: "å›½", pinyinBase: "guo", tone: 2, initial: "g", final: "uo"}, {char: "å®¶", pinyinBase: "jia", tone: 1, initial: "j", final: "ia"}], english: "country; nation"},{word: "çˆ±", pinyin: "Ã i", syllables: [{char: "çˆ±", pinyinBase: "ai", tone: 4, initial: "", final:"ai"}], english:"love; like"},{word: "å­¦ä¹ ", pinyin: "xuÃ© xÃ­", syllables: [{char: "å­¦", pinyinBase: "xue", tone: 2, initial: "x", final: "Ã¼e"}, {char: "ä¹ ", pinyinBase: "xi", tone: 2, initial: "x", final: "i"}], english: "study; learn"},{word: "æœ‹å‹", pinyin: "pÃ©ng yÇ’u", syllables: [{char: "æœ‹", pinyinBase: "peng", tone: 2, initial: "p", final: "eng"}, {char: "å‹", pinyinBase: "you", tone: 3, initial: "y", final: "ou"}], english: "friend; pal"},{word: "å¤©ç©º", pinyin: "tiÄn kÅng", syllables: [{char: "å¤©", pinyinBase: "tian", tone: 1, initial: "t", final: "ian"}, {char: "ç©º", pinyinBase: "kong", tone: 1, initial: "k", final: "ong"}], english: "sky; heaven"},{word: "åå­—", pinyin: "mÃ­ng zi", syllables: [{char: "å", pinyinBase: "ming", tone: 2, initial: "m", final: "ing"}, {char: "å­", pinyinBase: "zi", tone: 5, initial: "z", final: "i"}], english: "name; given name"},{word: "å¸®åŠ©", pinyin: "bÄng zhÃ¹", syllables: [{char: "å¸®", pinyinBase: "bang", tone: 1, initial: "b", final: "ang"}, {char: "åŠ©", pinyinBase: "zhu", tone: 4, initial: "zh", final: "u"}], english: "help; assist"},{word: "å‹‡æ•¢", pinyin: "yÇ’ng gÇn", syllables: [{char: "å‹‡", pinyinBase: "yong", tone: 3, initial: "y", final: "ong"}, {char: "æ•¢", pinyinBase: "gan", tone: 3, initial: "g", final: "an"}], english: "brave; courageous"},{word: "å–œæ¬¢", pinyin: "xÇ huÄn", syllables: [{char: "å–œ", pinyinBase: "xi", tone: 3, initial: "x", final: "i"}, {char: "æ¬¢", pinyinBase: "huan", tone: 1, initial: "h", final: "uan"}], english: "like; be fond of"},{word: "è§‰å¾—", pinyin: "juÃ© de", syllables: [{char: "è§‰", pinyinBase: "jue", tone: 2, initial: "j", final: "Ã¼e"}, {char: "å¾—", pinyinBase: "de", tone: 5, initial: "d", final: "e"}], english: "think; feel"},{word: "å¯é ", pinyin: "kÄ› kÃ o", syllables: [{char: "å¯", pinyinBase: "ke", tone: 3, initial: "k", final: "e"}, {char: "é ", pinyinBase: "kao", tone: 4, initial: "k", final: "ao"}], english: "reliable; trustworthy"},{word: "è‹±é›„", pinyin: "yÄ«ng xiÃ³ng", syllables: [{char: "è‹±", pinyinBase: "ying", tone: 1, initial: "y", final: "ing"}, {char: "é›„", pinyinBase: "xiong", tone: 2, initial: "x", final: "iong"}], english: "hero; heroic person"},{word: "ç‰¹è´¨", pinyin: "tÃ¨ zhÃ¬", syllables: [{char: "ç‰¹", pinyinBase: "te", tone: 4, initial: "t", final: "e"}, {char: "è´¨", pinyinBase: "zhi", tone: 4, initial: "zh", final: "i"}], english: "trait; characteristic"}],
      4: [
        {word: "ä¸ªäºº", pinyin: "gÃ¨ rÃ©n",
          syllables: [
            {char: "ä¸ª", pinyinBase: "ge", tone: 4, initial: "g", final: "e"},
            {char: "äºº", pinyinBase: "ren", tone: 2, initial: "r", final: "en"}
          ],
          english: "personal; individual"
        },
        {word: "ç¤¾ä¼š", pinyin: "shÃ¨ huÃ¬",
          syllables: [
            {char: "ç¤¾", pinyinBase: "she", tone: 4, initial: "sh", final: "e"},
            {char: "ä¼š", pinyinBase: "hui", tone: 4, initial: "h", final: "ui"}
          ],
          english: "society; social"
        },
        {word: "è§’è‰²", pinyin: "juÃ© sÃ¨",
          syllables: [
            {char: "è§’", pinyinBase: "jue", tone: 2, initial: "j", final: "ue"},
            {char: "è‰²", pinyinBase: "se", tone: 4, initial: "s", final: "e"}
          ],
          english: "role; character"
        },
        {word: "ä»£è¡¨", pinyin: "dÃ i biÇo",
          syllables: [
            {char: "ä»£", pinyinBase: "dai", tone: 4, initial: "d", final: "ai"},
            {char: "è¡¨", pinyinBase: "biao", tone: 3, initial: "b", final: "iao"}
          ],
          english: "representative; to represent"
        },
        {word: "å…´è¶£", pinyin: "xÃ¬ng qÃ¹",
          syllables: [
            {char: "å…´", pinyinBase: "xing", tone: 4, initial: "x", final: "ing"},
            {char: "è¶£", pinyinBase: "qu", tone: 4, initial: "q", final: "u"}
          ],
          english: "interest; hobby"
        },
        {word: "å®¶åº­",
          pinyin: "jiÄ tÃ­ng",
          syllables: [
            {char: "å®¶", pinyinBase: "jia", tone: 1, initial: "j", final: "ia"},
            {char: "åº­", pinyinBase: "ting", tone: 2, initial: "t", final: "ing"}
          ],
          english: "family; household"
        },
        {word: "å­¦æ ¡",pinyin: "xuÃ© xiÃ o",
          syllables: [
            {char: "å­¦", pinyinBase: "xue", tone: 2, initial: "x", final: "ue"},
            {char: "æ ¡", pinyinBase: "xiao", tone: 4, initial: "x", final: "iao"}
          ],
          english: "school"
        },
        {word: "æ´»åŠ¨",pinyin: "huÃ³ dÃ²ng",
          syllables: [
            {char: "æ´»", pinyinBase: "huo", tone: 2, initial: "h", final: "uo"},
            {char: "åŠ¨", pinyinBase: "dong", tone: 4, initial: "d", final: "ong"}
          ],
          english: "activity; event"
        },
        {word: "è€å¸ˆ",pinyin: "lÇo shÄ«",
          syllables: [
            {char: "è€", pinyinBase: "lao", tone: 3, initial: "l", final: "ao"},
            {char: "å¸ˆ", pinyinBase: "shi", tone: 1, initial: "sh", final: "i"}
          ],
          english: "teacher"
        },
        {
          word: "å¿ƒæƒ…",
          pinyin: "xÄ«n qÃ­ng",
          syllables: [
            {char: "å¿ƒ", pinyinBase: "xin", tone: 1, initial: "x", final: "in"},
            {char: "æƒ…", pinyinBase: "qing", tone: 2, initial: "q", final: "ing"}
          ],
          english: "mood; feeling"
        },
        {
          word: "åšé¥­",
          pinyin: "zuÃ² fÃ n",
          syllables: [
            {char: "åš", pinyinBase: "zuo", tone: 4, initial: "z", final: "uo"},
            {char: "é¥­", pinyinBase: "fan", tone: 4, initial: "f", final: "an"}
          ],
          english: "to cook; cooking"
        },
        {
          word: "è¡£æœ",
          pinyin: "yÄ« fu",
          syllables: [
            {char: "è¡£", pinyinBase: "yi", tone: 1, initial: "y", final: "i"},
            {char: "æœ", pinyinBase: "fu", tone: 5, initial: "f", final: "u"} // è½»å£°å¤„ç†
          ],
          english: "clothes; clothing"
        },
        {
          word: "é£Ÿç‰©",
          pinyin: "shÃ­ wÃ¹",
          syllables: [
            {char: "é£Ÿ", pinyinBase: "shi", tone: 2, initial: "sh", final: "i"},
            {char: "ç‰©", pinyinBase: "wu", tone: 4, initial: "w", final: "u"}
          ],
          english: "food"
        },
        {
          word: "å”±æ­Œ",
          pinyin: "chÃ ng gÄ“",
          syllables: [
            {char: "å”±", pinyinBase: "chang", tone: 4, initial: "ch", final: "ang"},
            {char: "æ­Œ", pinyinBase: "ge", tone: 1, initial: "g", final: "e"}
          ],
          english: "to sing; singing"
        },
        {
          word: "çœ‹ç”µå½±",
          pinyin: "kÃ n diÃ n yÇng",
          syllables: [
            {char: "çœ‹", pinyinBase: "kan", tone: 4, initial: "k", final: "an"},
            {char: "ç”µ", pinyinBase: "dian", tone: 4, initial: "d", final: "ian"},
            {char: "å½±", pinyinBase: "ying", tone: 3, initial: "y", final: "ing"}
          ],
          english: "to watch a movie; watching movies"
        },
        {
          word: "è¯»ä¹¦",
          pinyin: "dÃº shÅ«",
          syllables: [
            {char: "è¯»", pinyinBase: "du", tone: 2, initial: "d", final: "u"},
            {char: "ä¹¦", pinyinBase: "shu", tone: 1, initial: "sh", final: "u"}
          ],
          english: "to read; studying"
        },
        {
          word: "æ—¶å€™",
          pinyin: "shÃ­ hou",
          syllables: [
            {char: "æ—¶", pinyinBase: "shi", tone: 2, initial: "sh", final: "i"},
            {char: "å€™", pinyinBase: "hou", tone: 4, initial: "h", final: "ou"}
          ],
          english: "time; moment"
        },
        {
          word: "äº²è¿‘",
          pinyin: "qÄ«n jÃ¬n",
          syllables: [
            {char: "äº²", pinyinBase: "qin", tone: 1, initial: "q", final: "in"},
            {char: "è¿‘", pinyinBase: "jin", tone: 4, initial: "j", final: "in"}
          ],
          english: "intimate; close"
        },
        {
          word: "ä¸¾æ‰‹",
          pinyin: "jÇ” shÇ’u",
          syllables: [
            {char: "ä¸¾", pinyinBase: "ju", tone: 3, initial: "j", final: "u"},
            {char: "æ‰‹", pinyinBase: "shou", tone: 3, initial: "sh", final: "ou"}
          ],
          english: "to raise one's hand"
        },
        {
          word: "å¤§ç¬‘",
          pinyin: "dÃ  xiÃ o",
          syllables: [
            {char: "å¤§", pinyinBase: "da", tone: 4, initial: "d", final: "a"},
            {char: "ç¬‘", pinyinBase: "xiao", tone: 4, initial: "x", final: "iao"}
          ],
          english: "laugh"
        },
        {
          word: "åˆ†äº«",
          pinyin: "fÄ“n xiÇng",
          syllables: [
            {char: "åˆ†", pinyinBase: "fen", tone: 1, initial: "f", final: "en"},
            {char: "äº«", pinyinBase: "xiang", tone: 3, initial: "x", final: "iang"}
          ],
          english: "to share"
        },
        {
          word: "æ¯”èµ›",
          pinyin: "bÇ sÃ i",
          syllables: [
            {char: "æ¯”", pinyinBase: "bi", tone: 3, initial: "b", final: "i"},
            {char: "èµ›", pinyinBase: "sai", tone: 4, initial: "s", final: "ai"}
          ],
          english: "competition; match"
        },
        {
          word: "å‘¨æœ«",
          pinyin: "zhÅu mÃ²",
          syllables: [
            {char: "å‘¨", pinyinBase: "zhou", tone: 1, initial: "zh", final: "ou"},
            {char: "æœ«", pinyinBase: "mo", tone: 4, initial: "m", final: "o"}
          ],
          english: "weekend"
        },
        {
          word: "è‡ªå·±",
          pinyin: "zÃ¬ jÇ",
          syllables: [
            {char: "è‡ª", pinyinBase: "zi", tone: 4, initial: "z", final: "i"},
            {char: "å·±", pinyinBase: "ji", tone: 3, initial: "j", final: "i"}
          ],
          english: "oneself; self"
        }
        {word: "ç‰¹åˆ«", pinyin: "tÃ¨ biÃ©", syllables: [{char: "ç‰¹", pinyinBase: "te", tone: 4, initial: "t", final: "e"}, {char: "åˆ«", pinyinBase: "bie", tone: 2, initial: "b", final: "ie"}], english: "special; especially"},{word: "ä¹ æƒ¯", pinyin: "xÃ­ guÃ n", syllables: [{char: "ä¹ ", pinyinBase: "xi", tone: 2, initial: "x", final: "i"}, {char: "æƒ¯", pinyinBase: "guan", tone: 4, initial: "g", final: "uan"}], english: "habit; custom"},{word: "ä¼ ç»Ÿ", pinyin: "chuÃ¡n tÇ’ng", syllables: [{char: "ä¼ ", pinyinBase: "chuan", tone: 2, initial: "ch", final: "uan"}, {char: "ç»Ÿ", pinyinBase: "tong", tone: 3, initial: "t", final: "ong"}], english: "tradition; conventional"},{word: "è´£ä»»", pinyin: "zÃ© rÃ¨n", syllables: [{char: "è´£", pinyinBase: "ze", tone: 2, initial: "z", final: "e"}, {char: "ä»»", pinyinBase: "ren", tone: 4, initial: "r", final: "en"}], english: "responsibility; duty"},{word: "é‡‡è®¿", pinyin: "cÇi fÇng", syllables: [{char: "é‡‡", pinyinBase: "cai", tone: 3, initial: "c", final: "ai"}, {char: "è®¿", pinyinBase: "fang", tone: 3, initial: "f", final: "ang"}], english: "interview; cover"},{word: "æ£’çƒ", pinyin: "bÃ ng qiÃº", syllables: [{char: "æ£’", pinyinBase: "bang", tone: 4, initial: "b", final: "ang"}, {char: "çƒ", pinyinBase: "qiu", tone: 2, initial: "q", final: "iu"}], english: "baseball"},{word: "éœ²è¥", pinyin: "lÃ¹ yÃ­ng", syllables: [{char: "éœ²", pinyinBase: "lu", tone: 4, initial: "l", final: "u"}, {char: "è¥", pinyinBase: "ying", tone: 2, initial: "y", final: "ing"}], english: "camping; camp"},{word: "çƒé˜Ÿ", pinyin: "qiÃº duÃ¬", syllables: [{char: "çƒ", pinyinBase: "qiu", tone: 2, initial: "q", final: "iu"}, {char: "é˜Ÿ", pinyinBase: "dui", tone: 4, initial: "d", final: "ui"}], english: "team; ball team"},{word: "æ¡åƒåœ¾", pinyin: "jiÇn lÄ jÄ«", syllables: [{char: "æ¡", pinyinBase: "jian", tone: 3, initial: "j", final: "ian"}, {char: "åƒ", pinyinBase: "la", tone: 1, initial: "l", final: "a"}, {char: "åœ¾", pinyinBase: "ji", tone: 1, initial: "j", final: "i"}], english: "pick up garbage; collect trash"},{word: "é›ç‹—", pinyin: "liÃ¹ gÇ’u", syllables: [{char: "é›", pinyinBase: "liu", tone: 4, initial: "l", final: "iu"}, {char: "ç‹—", pinyinBase: "gou", tone: 3, initial: "g", final: "ou"}], english: "walk the dog"},{word: "è·‘æ­¥", pinyin: "pÇo bÃ¹", syllables: [{char: "è·‘", pinyinBase: "pao", tone: 3, initial: "p", final: "ao"}, {char: "æ­¥", pinyinBase: "bu", tone: 4, initial: "b", final: "u"}], english: "run; jog"},{word: "ç­é•¿", pinyin: "bÄn zhÇng", syllables: [{char: "ç­", pinyinBase: "ban", tone: 1, initial: "b", final: "an"}, {char: "é•¿", pinyinBase: "zhang", tone: 3, initial: "zh", final: "ang"}], english: "monitor; class president"},{word: "çƒå‘˜", pinyin: "qiÃº yuÃ¡n", syllables: [{char: "çƒ", pinyinBase: "qiu", tone: 2, initial: "q", final: "iu"}, {char: "å‘˜", pinyinBase: "yuan", tone: 2, initial: "y", final: "uan"}], english: "player; team member"},{word: "çƒåœº", pinyin: "qiÃº chÇng", syllables: [{char: "çƒ", pinyinBase: "qiu", tone: 2, initial: "q", final: "iu"}, {char: "åœº", pinyinBase: "chang", tone: 3, initial: "ch", final: "ang"}], english: "court; stadium"},{word: "å­©å­", pinyin: "hÃ¡i zi", syllables: [{char: "å­©", pinyinBase: "hai", tone: 2, initial: "h", final: "ai"}, {char: "å­", pinyinBase: "zi", tone: 5, initial: "z", final: "i"}], english: "child; kid"},{word: "åˆå”±å›¢", pinyin: "hÃ© chÃ ng tuÃ¡n", syllables: [{char: "åˆ", pinyinBase: "he", tone: 2, initial: "h", final: "e"}, {char: "å”±", pinyinBase: "chang", tone: 4, initial: "ch", final: "ang"}, {char: "å›¢", pinyinBase: "tuan", tone: 2, initial: "t", final: "uan"}], english: "choir; chorus"},{word: "å€¼æ—¥ç”Ÿ", pinyin: "zhÃ­ rÃ¬ shÄ“ng", syllables: [{char: "å€¼", pinyinBase: "zhi", tone: 2, initial: "zh", final: "i"}, {char: "æ—¥", pinyinBase: "ri", tone: 4, initial: "r", final: "i"}, {char: "ç”Ÿ", pinyinBase: "sheng", tone: 1, initial: "sh", final: "eng"}], english: "on-duty student; duty roster"},{word: "äº†è§£", pinyin: "liÇo jiÄ›", syllables: [{char: "äº†", pinyinBase: "liao", tone: 3, initial: "l", final: "iao"}, {char: "è§£", pinyinBase: "jie", tone: 3, initial: "j", final: "ie"}], english: "understand; know about"},{word: "è¶…çº§", pinyin: "chÄo jÃ­", syllables: [{char: "è¶…", pinyinBase: "chao", tone: 1, initial: "ch", final: "ao"}, {char: "çº§", pinyinBase: "ji", tone: 2, initial: "j", final: "i"}], english: "super; ultra"},{word: "å¼¹å‰ä»–", pinyin: "tÃ¡n jÃ­ tÄ", syllables: [{char: "å¼¹", pinyinBase: "tan", tone: 2, initial: "t", final: "an"}, {char: "å‰", pinyinBase: "ji", tone: 2, initial: "j", final: "i"}, {char: "ä»–", pinyinBase: "ta", tone: 1, initial: "t", final: "a"}], english: "play the guitar"},{word: "æ‰“é¼“", pinyin: "dÇ gÇ”", syllables: [{char: "æ‰“", pinyinBase: "da", tone: 3, initial: "d", final: "a"}, {char: "é¼“", pinyinBase: "gu", tone: 3, initial: "g", final: "u"}], english: "play the drums"},{word: "ç‚’èœ", pinyin: "chÇo cÃ i", syllables: [{char: "ç‚’", pinyinBase: "chao", tone: 3, initial: "ch", final: "ao"}, {char: "èœ", pinyinBase: "cai", tone: 4, initial: "c", final: "ai"}], english: "stir-fry; cook dishes"},{word: "åŒ…é¥ºå­", pinyin: "bÄo jiÇo zi", syllables: [{char: "åŒ…", pinyinBase: "bao", tone: 1, initial: "b", final: "ao"}, {char: "é¥º", pinyinBase: "jiao", tone: 3, initial: "j", final: "iao"}, {char: "å­", pinyinBase: "zi", tone: 5, initial: "z", final: "i"}], english: "make dumplings"}
      ]
    };

    const gradeBtns = document.querySelectorAll(".grade-btn");
    const numBtns = document.querySelectorAll(".num-btn");
    const customInput = document.getElementById("custom-num");
    const startBtn = document.getElementById("start-game");
    const homeSection = document.getElementById("home");
    const gameSection = document.getElementById("game");
    const endSection = document.getElementById("end");
    const gameGradeEl = document.getElementById("game-grade");
    const qCountEl = document.getElementById("q-count");
    const wordDisplay = document.getElementById("word-display");
    const metaLineEl = document.getElementById("meta-line");
    const playSoundBtn = document.getElementById("play-sound");
    const choicesEl = document.getElementById("choices");
    const nextBtn = document.getElementById("next-btn");
    const quitBtn = document.getElementById("quit-btn");
    const progressBar = document.getElementById("progress-bar");
    const scoreText = document.getElementById("score-text");
    const finalScoreEl = document.getElementById("final-score");
    const encourageEl = document.getElementById("encourage");
    const retryBtn = document.getElementById("retry-btn");
    const backHomeBtn = document.getElementById("back-home-btn");
    const audioEl = document.getElementById("audio");
    const recBtn = document.getElementById("rec-btn");
    const stopRecBtn = document.getElementById("stop-rec-btn");
    const recStatus = document.getElementById("rec-status");
    const transcriptEl = document.getElementById("transcript");
    const userRecAudio = document.getElementById("user-rec-audio");
    const stageIndicator = document.getElementById("stage-indicator");

    let selectedGrade = 4, selectedNum = "all", customNum = null;
    let pool = [], order = [], cur = 0, total = 0, score = 0;
    let recDone = false, recCorrect = false;
    let choiceSelected = false, isChoiceCorrect = false;
    let mediaStream = null, mediaRecorder = null, recordedChunks = [], recognition = null;
    let consecutiveCorrect = 0;
    let selectedWords = new Set();
    let isCustomWords = false;

    function shuffleArray(a) {
      const arr = a.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function buildPoolForGrade(g) {
      return gradeWords[g] || [];
    }

    function markTone(syllable, tone) {
      if (tone === 5) return syllable;
      if (!tone || tone === 0) return syllable;
      let s = syllable.replace(/v/g,'Ã¼');
      const toneMap = {a:['Ä','Ã¡','Ç','Ã '],o:['Å','Ã³','Ç’','Ã²'],e:['Ä“','Ã©','Ä›','Ã¨'],
                       i:['Ä«','Ã­','Ç','Ã¬'],u:['Å«','Ãº','Ç”','Ã¹'],Ã¼:['Ç–','Ç˜','Çš','Çœ']};
      const lower = s.toLowerCase();
      let targetIndex = -1;
      if (lower.includes('iu')) targetIndex = lower.indexOf('iu') + 1;
      else if (lower.includes('ui')) targetIndex = lower.indexOf('ui') + 1;
      else {
        const order = ['a','o','e','i','u','Ã¼'];
        for (let ch of order) { const idx = lower.indexOf(ch); if (idx !== -1) { targetIndex = idx; break; } }
      }
      if (targetIndex === -1) return s;
      const ch = s[targetIndex].toLowerCase();
      const marks = toneMap[ch];
      if (!marks) return s;
      const mark = marks[tone - 1];
      s = s.substring(0, targetIndex) + mark + s.substring(targetIndex + 1);
      if (['j','q','x'].includes(s[0]) && s.includes('Ã¼')) s = s.replace('Ã¼','u');
      return s;
    }

    function buildWordPinyinMarked(syllables) {
      return syllables.map(s => markTone(s.pinyinBase, s.tone)).join(' ');
    }

    function playBaiduTtsForWord(word) {
      const url = `https://tts.baidu.com/text2audio?tex=${word}&cuid=dict&lan=ZH&ctp=2&pdt=30&vol=9`;
      audioEl.src = url; 
      audioEl.play().catch(() => {
        recStatus.textContent = "ï¼ˆè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¬å–å‘éŸ³ï¼‰";
      });
    }

    // ä¿®æ”¹ï¼šæ”¹è¿›å¹²æ‰°é€‰é¡¹ç”Ÿæˆé€»è¾‘ï¼Œæ›´å¤šåˆ©ç”¨similarInitialså’ŒsimilarFinals
    function generatePinyinOptions(syllables, correctPinyin) {
      // ä½¿ç”¨è¯è¯­è‡ªå¸¦çš„æ­£ç¡®æ‹¼éŸ³ä½œä¸ºåŸºå‡†
      const correct = correctPinyin;
      const variants = new Set([correct]);
      const similarInitials = {b:["p","d"],p:["b","d"],m:["n"],f:["t","h"],d:["t","b","p","q"],t:["d","f"],
        n:["l","m"],l:["n","r"],g:["k","q"],k:["g","h"],h:["k","g"],j:["q","x"],q:["j","x"],x:["j","q"],
        zh:["ch","sh","z","j"],ch:["zh","sh","c"],sh:["ch","zh","s"],r:["l","y"],z:["c","s"],c:["z","s"],
        s:["z","c","x"],y:["j","w"],w:["y","j"]};
      const similarFinals = {"a": ["ai", "an"],
      "o": ["ou", "ong"],
      "e": ["ei", "en"],
      "i": ["ie", "in"],
      "u": ["Ã¼", "un"],
      "Ã¼": ["Ã¼e", "un"],
      "ai": ["a", "ei"],
      "ei": ["ai", "e"],
      "ui": ["u", "ou"],
      "ao": ["ou", "a"],
      "ou": ["uo", "ong"],
      "iu": ["i", "u"],
      "ie": ["i", "e"],
      "Ã¼e": ["Ã¼", "e"],
      "an": ["ang", "a"],
      "en": ["eng", "e"],
      "in": ["ing", "i"],
      "un": ["ong", "Ã¼e"],
      "ang": ["an", "a"],
      "eng": ["en", "e"],
      "ing": ["in", "i"],
      "ong": ["un", "ou"],
      "ia": ["ie", "iao"],
      "iao": ["ia", "ao"],
      "ian": ["iang", "an"],
      "iang": ["ian", "ang"],
      "iong": ["ong", "ing"],
      "ua": ["uo", "uai"],
      "uo": ["ua", "o"],
      "uai": ["ua", "ai"],
      "uan": ["uang", "an"],
      "uang": ["uan", "ang"],
      "er": ["e", "Ã¼e"]};

        // æ›´ç²¾ç¡®çš„å¹²æ‰°é¡¹ç”Ÿæˆæ–¹æ³•
      function perturbSyllable(item) {
        const copy = {...item};
        const r = Math.random();
        
        // 80%æ¦‚ç‡æ›¿æ¢å£°æ¯æˆ–éŸµæ¯ï¼ˆä½¿ç”¨similaræ•°æ®ï¼‰
        if (r < 0.4) {
          // æ›¿æ¢å£°æ¯
          if (similarInitials[copy.initial]) {
            const sim = similarInitials[copy.initial];
            copy.initial = sim[Math.floor(Math.random() * sim.length)];
            // æ›´æ–°æ‹¼éŸ³åŸºç¡€
            copy.pinyinBase = copy.initial + copy.final;
          }
        } else if (r < 0.8) {
          // æ›¿æ¢éŸµæ¯
          if (similarFinals[copy.final]) {
            const sim = similarFinals[copy.final];
            copy.final = sim[Math.floor(Math.random() * sim.length)];
            // æ›´æ–°æ‹¼éŸ³åŸºç¡€
            copy.pinyinBase = copy.initial + copy.final;
          }
        } else {
          // 20%æ¦‚ç‡æ”¹å˜å£°è°ƒ
          let newTone = copy.tone;
          while (newTone === copy.tone) newTone = Math.floor(Math.random() * 4) + 1;
          copy.tone = newTone;
        }
        
        return copy;
      }

      // ç”Ÿæˆè¶³å¤Ÿçš„å¹²æ‰°é¡¹
      while (variants.size < 4) {
        const copy = syllables.map(s => ({...s}));
        // éšæœºé€‰æ‹©ä¸€ä¸ªéŸ³èŠ‚è¿›è¡Œå¹²æ‰°
        const idx = Math.floor(Math.random() * copy.length);
        copy[idx] = perturbSyllable(copy[idx]);
        const cand = buildWordPinyinMarked(copy);
        if (cand !== correct) variants.add(cand);
      }
      
      return shuffleArray(Array.from(variants));
    }

    function startGame() {
      if (isCustomWords && selectedWords.size > 0) {
        const allWords = Object.values(gradeWords).flat();
        pool = allWords.filter(w => selectedWords.has(w.word));
      } else {
        pool = buildPoolForGrade(selectedGrade);
      }

      let n = pool.length;
      if (selectedNum !== "all") {
        const cap = selectedNum === "custom" ? customNum : parseInt(selectedNum);
        n = Math.min(cap || n, pool.length);
      }
      if (n < pool.length) pool = shuffleArray(pool).slice(0,n);
      total = pool.length; score = 0; cur = 0;
      order = shuffleArray(Array.from(Array(total).keys()));

      homeSection.style.display = "none";
      gameSection.style.display = "block";
      endSection.style.display = "none";
      gameGradeEl.textContent = isCustomWords ? "è‡ªå®šä¹‰é€‰è¯" : `å››å¹´çº§`;
      qCountEl.textContent = `${cur+1} / ${total}`;
      scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
      progressBar.style.width = `0%`;
      showQuestion(cur);
    }

    function showQuestion(index) {
      // é‡ç½®æ‰€æœ‰çŠ¶æ€
      recDone = false;
      recCorrect = false;
      choiceSelected = false;
      isChoiceCorrect = false;
      nextBtn.style.display = "none";
      
      // é‡ç½®UI
      transcriptEl.textContent = "ï¼ˆè¯†åˆ«ç»“æœï¼‰";
      transcriptEl.style.borderColor = transcriptEl.style.background = transcriptEl.style.color = "";
      userRecAudio.style.display = "none";
      userRecAudio.src = "";
      recStatus.textContent = "ï¼ˆæœªå½•éŸ³ï¼‰";
      recBtn.style.display = "inline-block";
      stopRecBtn.style.display = "none";
      choicesEl.innerHTML = "";
      stageIndicator.textContent = "ç¬¬ä¸€é˜¶æ®µï¼šè¯·å…ˆæœ—è¯»è¯è¯­å¹¶å½•éŸ³éªŒè¯";
      stageIndicator.style.backgroundColor = "#f0f7ff";
      stageIndicator.style.color = "#1976d2";

      // åœæ­¢å¹¶æ¸…ç†åª’ä½“èµ„æº
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
      if (recognition && recognition.state !== "inactive") {
        recognition.stop();
        recognition = null;
      }
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      recordedChunks = [];

      const q = pool[order[index]];
      wordDisplay.textContent = q.word;
      metaLineEl.textContent = q.english || "ï¼ˆè‹±æ–‡é‡Šä¹‰æš‚ç¼ºï¼‰";
      qCountEl.textContent = `${index+1} / ${total}`;
      progressBar.style.width = Math.round((index/total)*100) + "%";
      
    }

    function checkStageProgress() {
      const q = pool[order[cur]];
      
      // ç¬¬ä¸€é˜¶æ®µï¼šå½•éŸ³æ­£ç¡®åæ˜¾ç¤ºé€‰é¡¹
      if (!choiceSelected && recDone && recCorrect) {
        stageIndicator.textContent = "ç¬¬äºŒé˜¶æ®µï¼šè¯·é€‰æ‹©æ­£ç¡®çš„æ‹¼éŸ³";
        stageIndicator.style.backgroundColor = "#e8f5e9";
        stageIndicator.style.color = "#2e7d32";
        
        // ç”Ÿæˆå¹¶æ˜¾ç¤ºé€‰é¡¹ï¼Œä½¿ç”¨è¯è¯­è‡ªå¸¦çš„æ‹¼éŸ³
        const opts = generatePinyinOptions(q.syllables, q.pinyin);
        choicesEl.innerHTML = "";
        for (const text of opts) {
          const btn = document.createElement("button");
          btn.className = "choice";
          btn.textContent = text;
          btn.addEventListener("click", ()=> {
            document.querySelectorAll(".choice").forEach(b => b.disabled = true);
            const correctStr = q.pinyin; // ä½¿ç”¨è¯è¯­è‡ªå¸¦çš„æ­£ç¡®æ‹¼éŸ³
            if (text === correctStr) {
              btn.classList.add("correct");
              isChoiceCorrect = true;
              score++; 
              scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
            } else {
              btn.classList.add("wrong");
              document.querySelectorAll(".choice").forEach(b => {
                if (b.textContent === correctStr) b.classList.add("correct");
              });
            }
            choiceSelected = true;
            nextBtn.style.display = "inline-block";
          });
          choicesEl.appendChild(btn);
        }
      }
    }

    async function ensureMediaStream() {
      if (mediaStream) return mediaStream;
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      return mediaStream;
    }

    function createRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return null;
      const rec = new SpeechRecognition();
      rec.lang = 'zh-CN';
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      return rec;
    }

    recBtn.addEventListener("click", async ()=>{
      try {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }
        
        const stream = await ensureMediaStream();
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => e.data.size && recordedChunks.push(e.data);
        mediaRecorder.onstart = () => {
          recStatus.textContent = "ï¼ˆæ­£åœ¨å½•éŸ³...è¯·æœ—è¯»è¯è¯­ï¼‰";
          recBtn.style.display = "none";
          stopRecBtn.style.display = "inline-block";
          transcriptEl.textContent = "ï¼ˆå½•éŸ³ä¸­...ï¼‰";
        };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, {type:'audio/webm'});
          userRecAudio.src = URL.createObjectURL(blob);
          userRecAudio.style.display = "inline-block";
          recStatus.textContent = "ï¼ˆå½•éŸ³å®Œæˆï¼Œæ­£åœ¨è¯†åˆ«...ï¼‰";
          recBtn.style.display = "inline-block";
          stopRecBtn.style.display = "none";
          recDone = true;
        };
        mediaRecorder.start();
      } catch (e) { 
        alert("æ— æ³•å½•éŸ³ï¼š" + e.message); 
        recStatus.textContent = "ï¼ˆå½•éŸ³å¤±è´¥ï¼‰";
      }

      if (recognition && recognition.state !== "inactive") {
        recognition.stop();
      }
      recognition = createRecognition();
      
      if (!recognition) {
        transcriptEl.textContent = "ï¼ˆæµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼‰";
        transcriptEl.style.color = "#B71C1C";
        return;
      }
      
      transcriptEl.textContent = "ï¼ˆç­‰å¾…è¯†åˆ«...ï¼‰";
      const q = pool[order[cur]];
      recognition.onresult = e => {
        const text = Array.from(e.results).map(r=>r[0].transcript).join('');
        transcriptEl.textContent = text || "ï¼ˆæœªè¯†åˆ«åˆ°ï¼‰";
        const normalized = text.replace(/\s+/g,'');
        // ä¸¥æ ¼éªŒè¯ï¼šå¿…é¡»åŒ…å«æ‰€æœ‰å­—ç¬¦
        const ok = q.word.split('').every(ch => normalized.includes(ch));
        
        if (ok) {
          transcriptEl.style.borderColor = "#4CAF50";
          transcriptEl.style.background = "#E8F5E9";
          transcriptEl.style.color = "#1B5E20";
          recCorrect = true;
          recStatus.textContent = "ï¼ˆæœ—è¯»æ­£ç¡®ï¼ï¼‰";
        } else {
          transcriptEl.style.borderColor = "#E53935";
          transcriptEl.style.background = "#FFEBEE";
          transcriptEl.style.color = "#B71C1C";
          recCorrect = false;
          recStatus.textContent = "ï¼ˆæœ—è¯»ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•ï¼‰";
        }
        
        checkStageProgress();
      };
      
      recognition.onerror = e => {
        transcriptEl.textContent = "ï¼ˆè¯†åˆ«å‡ºé”™ï¼‰";
        transcriptEl.style.color = "#B71C1C";
        recStatus.textContent = "ï¼ˆè¯·é‡è¯•ï¼‰";
      };
      
      recognition.start();
    });

    stopRecBtn.addEventListener("click", ()=>{
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
      if (recognition && recognition.state !== "inactive") {
        recognition.stop();
      }
    });

    playSoundBtn.addEventListener("click", ()=>{
      const q = pool[order[cur]];
      playBaiduTtsForWord(q.word);
    });

    nextBtn.addEventListener("click", ()=>{
      cur++;
      if (cur < total) {
        showQuestion(cur);
      } else {
        endGame();
      }
    });

    function endGame() {
      gameSection.style.display = "none"; 
      endSection.style.display = "block";
      const pct = Math.round((score/total)*100);
      finalScoreEl.textContent = `${score} / ${total} = ${pct}%`;

      // è®¡ç®—Dojoåˆ†
      let dojoPoints = 0;
      let dojoText = "";
      let showDojoInfo = total >= 20;
      if (showDojoInfo) {
      if (pct >= 60 && pct < 70) {
        dojoPoints = 1;
        dojoText = "æ­å–œè·å¾—1ä¸ªDojoåˆ†";
      } else if (pct >= 70 && pct < 80) {
        dojoPoints = 2;
        dojoText = "æ­å–œè·å¾—2ä¸ªDojoåˆ†";
      } else if (pct >= 80 && pct < 90) {
        dojoPoints = 3;
        dojoText = "æ­å–œè·å¾—3ä¸ªDojoåˆ†";
      } else if (pct >= 90 && pct < 100) {
        dojoPoints = 4;
        dojoText = "æ­å–œè·å¾—4ä¸ªDojoåˆ†";
      } else if (pct === 100) {
        dojoPoints = 5;
        dojoText = "æ­å–œè·å¾—5ä¸ªDojoåˆ†";
      } else {
    showDojoInfo = false;
  }
}

      // æ ¹æ®åˆ†æ•°è®¾ç½®ä¸åŒé¼“åŠ±è¯­
      let phrases;
      if (pct >= 90) {
        phrases = [
          "å¤ªå‡ºè‰²äº†ï¼ç»§ç»­åŠ æ²¹ ğŸ’ª",
          "å¤ªæ£’äº†ï¼å†æŒ‘æˆ˜ä¸€æ¬¡å§ ğŸŒŸ",
          "å®Œç¾ï¼ç»§ç»­ä¿æŒå¥½ä¹ æƒ¯ ğŸ˜Š",
          "æƒŠäººçš„è¿›æ­¥ï¼Œç»§ç»­ç»ƒå°±æ›´æ£’ï¼ğŸ‰",
          "å¤ªä¼˜ç§€äº†ï¼ä½ çš„å‘éŸ³å ªç§°å®Œç¾ï¼ğŸ‘"
        ];
      } else if (pct >= 70) {
        phrases = [
          "åšå¾—å¾ˆå¥½ï¼ç»§ç»­åŠ æ²¹ ğŸ’ª",
          "å¾ˆä¸é”™ï¼å†æŒ‘æˆ˜ä¸€æ¬¡å§ ğŸŒŸ",
          "å®Œæˆå¾—å¾ˆæ£’ï¼Œç»§ç»­ä¿æŒå¥½ä¹ æƒ¯ ğŸ˜Š",
          "æœ‰æ˜æ˜¾è¿›æ­¥ï¼Œç»§ç»­ç»ƒå°±æ›´æ£’ï¼ğŸ‰",
          "è¡¨ç°ä¼˜ç§€ï¼ä½ çš„å‘éŸ³æ›´è¿›ä¸€æ­¥äº†ï¼ğŸ‘"
        ];
      } else if (pct >= 60) {
        phrases = [
          "æ­å–œè¿‡å…³ï¼ç»§ç»­åŠ æ²¹ ğŸ’ª",
          "åˆšå¥½åŠæ ¼ï¼Œå†æŒ‘æˆ˜ä¸€æ¬¡å§ ğŸŒŸ",
          "å®Œæˆäº†ç»ƒä¹ ï¼Œç»§ç»­ä¿æŒå¥½ä¹ æƒ¯ ğŸ˜Š",
          "æœ‰è¿›æ­¥ç©ºé—´ï¼Œç»§ç»­ç»ƒå°±æ›´æ£’ï¼ğŸ‰",
          "è¾¾åˆ°ç›®æ ‡äº†ï¼ä½ çš„å‘éŸ³è¿˜èƒ½æ›´å¥½ï¼ğŸ‘"
        ];
      } else {
        phrases = [
          "åˆ«ç°å¿ƒï¼Œå¤šç»ƒä¹ ä¸€å®šèƒ½è¿›æ­¥ ğŸ’ª",
          "è¿™æ¬¡æ²¡å‘æŒ¥å¥½ï¼Œå†è¯•ä¸€æ¬¡å§ ğŸŒŸ",
          "æ‰¾åˆ°ä¸è¶³å°±æ˜¯è¿›æ­¥çš„å¼€å§‹ ğŸ˜Š",
          "ç»§ç»­åŠªåŠ›ï¼Œä¸‹æ¬¡ä¸€å®šä¼šæ›´æ£’ï¼ğŸ‰",
          "åŠ æ²¹ï¼å¤šå¬å¤šç»ƒå°±èƒ½æé«˜å‘éŸ³ï¼ğŸ‘"
        ];
      }
      
      const randomPhrase = phrases[Math.floor(Math.random()*phrases.length)];
      
      if (dojoText) {
        encourageEl.textContent = `${randomPhrase} ${dojoText}`;
      } else {
        encourageEl.textContent = randomPhrase;
      }

      if (pct >= 60) {
        showCelebrationAnimation(pct);
      }
    }

    function showCelebrationAnimation(percentage) {
      const celebrationDiv = document.createElement("div");
      celebrationDiv.className = "celebration";
      document.body.appendChild(celebrationDiv);
      
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement("div");
        confetti.className = "confetti";
        confetti.style.left = Math.random() * 100 + "vw";
        confetti.style.animationDuration = (Math.random() * 3 + 2) + "s";
        confetti.style.animationDelay = Math.random() * 2 + "s";
        celebrationDiv.appendChild(confetti);
      }
      
      for (let i = 0; i < 10; i++) {
        setTimeout(() => {
          const firework = document.createElement("div");
          firework.className = "firework";
          firework.style.left = (Math.random() * 60 + 20) + "vw";
          firework.style.top = (Math.random() * 60 + 20) + "vh";
          firework.style.backgroundColor = [
            "#FF6F61", "#FFB74D", "#4DB6AC", "#64B5F6", "#BA68C8"
          ][Math.floor(Math.random() * 5)];
          celebrationDiv.appendChild(firework);
          
          setTimeout(() => {
            celebrationDiv.removeChild(firework);
          }, 1000);
        }, i * 300);
      }
      
      const supermanCount = percentage >= 90 ? 3 : (percentage >= 70 ? 2 : 1);
      for (let i = 0; i < supermanCount; i++) {
        setTimeout(() => {
          const superman = document.createElement("div");
          superman.className = "superman";
          superman.textContent = "ğŸ¦¸";
          superman.style.top = (30 + i * 20) + '%';
          document.body.appendChild(superman);
          
          setTimeout(() => {
            if (superman.parentNode) {
              document.body.removeChild(superman);
            }
          }, 3000);
        }, i * 500);
      }
      
      setTimeout(() => {
        document.body.removeChild(celebrationDiv);
      }, 5000);
    }

    quitBtn.addEventListener("click", ()=>{
      if (confirm("ç¡®å®šè¦ç»“æŸç»ƒä¹ å¹¶è¿”å›é¦–é¡µå—ï¼Ÿ")) {
        gameSection.style.display = "none";
        homeSection.style.display = "block";
      }
    });

    retryBtn.addEventListener("click", startGame);
    backHomeBtn.addEventListener("click", ()=>{
      endSection.style.display = "none";
      homeSection.style.display = "block";
    });

    gradeBtns.forEach(btn => {
      btn.addEventListener("click", ()=>{
        gradeBtns.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedGrade = parseInt(btn.dataset.grade);
        isCustomWords = false;
      });
    });

    numBtns.forEach(btn => {
      btn.addEventListener("click", ()=>{
        numBtns.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedNum = btn.dataset.num;
        customInput.value = "";
        isCustomWords = false;
      });
    });

    customInput.addEventListener("input", ()=>{
      numBtns.forEach(b => b.classList.remove("selected"));
      selectedNum = "custom";
      customNum = parseInt(customInput.value) || 1;
      isCustomWords = false;
    });

    startBtn.addEventListener("click", startGame);

    // è¯è¯­é€‰æ‹©å¼¹çª—ç›¸å…³
    const wordModal = document.getElementById("word-modal");
    const selectWordsBtn = document.getElementById("select-words");
    const startCustomBtn = document.getElementById("start-custom");
    const cancelModalBtn = document.getElementById("cancel-modal");
    const gradeSections = document.getElementById("grade-sections");

    selectWordsBtn.addEventListener("click", () => {
      // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
      gradeSections.innerHTML = "";
      selectedWords.clear();
      
      // ä¸ºæ¯ä¸ªå¹´çº§åˆ›å»ºè¯è¯­é€‰æ‹©åŒºåŸŸ
      for (const grade in gradeWords) {
        if (gradeWords[grade].length === 0) continue;
        
        const gradeSection = document.createElement("div");
        gradeSection.className = "grade-section";
        
        const gradeHeader = document.createElement("div");
        gradeHeader.className = "grade-header";
        gradeHeader.innerHTML = `
          <h3>${grade}å¹´çº§è¯è¯­</h3>
          <button class="select-all-btn" data-grade="${grade}">å…¨é€‰/å–æ¶ˆ</button>
        `;
        gradeSection.appendChild(gradeHeader);
        
        const wordGrid = document.createElement("div");
        wordGrid.className = "word-grid";
        
        // æ·»åŠ è¯¥å¹´çº§çš„æ‰€æœ‰è¯è¯­
        gradeWords[grade].forEach(wordData => {
          const wordBtn = document.createElement("div");
          wordBtn.className = "word-btn";
          wordBtn.textContent = wordData.word;
          wordBtn.dataset.word = wordData.word;
          
          wordBtn.addEventListener("click", () => {
            wordBtn.classList.toggle("selected");
            if (wordBtn.classList.contains("selected")) {
              selectedWords.add(wordData.word);
            } else {
              selectedWords.delete(wordData.word);
            }
          });
          
          wordGrid.appendChild(wordBtn);
        });
        
        gradeSection.appendChild(wordGrid);
        gradeSections.appendChild(gradeSection);
      }
      
      // æ·»åŠ å…¨é€‰/å–æ¶ˆåŠŸèƒ½
      document.querySelectorAll(".select-all-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const grade = btn.dataset.grade;
          const wordBtns = btn.closest(".grade-section").querySelectorAll(".word-btn");
          const allSelected = Array.from(wordBtns).every(b => b.classList.contains("selected"));
          
          wordBtns.forEach(b => {
            if (allSelected) {
              b.classList.remove("selected");
              selectedWords.delete(b.dataset.word);
            } else {
              b.classList.add("selected");
              selectedWords.add(b.dataset.word);
            }
          });
        });
      });
      
      wordModal.style.display = "flex";
    });

    startCustomBtn.addEventListener("click", () => {
      if (selectedWords.size === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¯è¯­");
        return;
      }
      
      isCustomWords = true;
      wordModal.style.display = "none";
      startGame();
    });

    cancelModalBtn.addEventListener("click", () => {
      wordModal.style.display = "none";
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    wordModal.addEventListener("click", (e) => {
      if (e.target === wordModal) {
        wordModal.style.display = "none";
      }
    });

    // åˆå§‹åŒ– - é»˜è®¤é€‰æ‹©å››å¹´çº§
    document.querySelector(`.grade-btn[data-grade="4"]`).classList.add("selected");
  </script>
</body>
</html>
