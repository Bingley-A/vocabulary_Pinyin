<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¯è¯­æ‹¼è¯»ç»ƒä¹ </title>
  <style>
    :root{
      --c1:#FF6F61; /* é²œè‰³çº¢ */
      --c2:#FFB74D; /* æ©™è‰² */
      --c3:#4DB6AC; /* ç»¿è‰² */
      --c4:#64B5F6; /* è“è‰² */
      --c5:#BA68C8; /* ç´«è‰² */
      --bg1:#FFF3E0;
      --bg2:#E1F5FE;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Comic Sans MS","Helvetica Neue",Arial,"PingFang SC",sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2),#F3E5F5);
      min-height:100vh;
      display:flex;align-items:center;justify-content:center;padding:20px;
      overflow-x:hidden;
    }
    .wrap{
      width:100%;max-width:980px;background:#fff;border-radius:18px;
      padding:18px;box-shadow:0 12px 40px rgba(0,0,0,0.12);
      position:relative;
      z-index:1;
    }
    header{display:flex;align-items:center;gap:12px}
    .logo{width:84px;height:84px;border-radius:18px;
      background:conic-gradient(from 45deg,var(--c1),var(--c2),var(--c3),var(--c4),var(--c5),var(--c1));
      display:flex;align-items:center;justify-content:center;color:#fff;font-size:40px;font-weight:900;box-shadow:0 8px 26px rgba(0,0,0,0.18)}
    h1{margin:0;font-size:24px;color:var(--c1)}
    main{margin-top:14px}

    /* é¦–é¡µ */
    #home{display:block}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 8px 22px rgba(0,0,0,0.06);margin-bottom:14px}
    .grade-selects{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .grade-btn{flex:1;min-width:120px;padding:14px;border-radius:12px;font-weight:900;
      background:linear-gradient(135deg,var(--c2),var(--c1));color:#fff;text-align:center;cursor:pointer;transition:.15s}
    .grade-btn.selected{outline:5px solid #64B5F6;transform:translateY(-4px)}
    .num-select{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .num-btn{padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;background:linear-gradient(135deg,var(--c3),var(--c4));color:#fff}
    .num-btn.selected{outline:4px solid #FFB74D;transform:scale(1.03)}
    .custom-box{display:flex;align-items:center;gap:8px;margin-top:10px}
    .custom-input{width:90px;padding:8px;border:3px solid var(--c4);border-radius:10px;text-align:center;font-weight:700}
    .start-btn{background:linear-gradient(90deg,var(--c1),var(--c2));border:none;color:#fff;
      padding:14px 20px;border-radius:14px;font-weight:900;font-size:16px;cursor:pointer;
      box-shadow:0 8px 28px rgba(0,0,0,0.18);margin-top:14px}

/* æ¸¸æˆç•Œé¢ */
#game{display:none;position: relative;} /* æ–°å¢position: relativeï¼Œä½¿å°åŠ¨ç‰©å›¾æ ‡ç›¸å¯¹æ¸¸æˆç•Œé¢å®šä½ */

.animal-emoji {
    position: fixed;
    font-size: 40px; /* Emojiå¤§å° */
    opacity: 0.5;
    z-index: 0; /* èƒŒæ™¯å±‚çº§ï¼Œä¸é®æŒ¡å†…å®¹ */
    pointer-events: none; /* é¼ æ ‡ç©¿é€ */
}

/* å„ä¸ªä½ç½®çš„åŠ¨ç‰©Emoji */
.animal-1 { top: 6%; left: 17%; } /* å·¦ä¸Šæ–¹åä¸­é—´ */
.animal-2 { top: 8%; right: 12%; } /* å³ä¸Šæ–¹åä¸‹ */
.animal-3 { bottom: 15%; left: 5%; } /* å·¦ä¸‹æ–¹åä¸Š */
.animal-4 { bottom: 12%; right: 8%; } /* å³ä¸‹æ–¹åä¸­é—´ */
.animal-5 { top: 40%; left: 3%; } /* å·¦ä¾§ä¸­é—´åä¸‹ */
.animal-6 { top: 55%; right: 5%; } /* å³ä¾§ä¸­é—´åä¸Š */

/* æ–°å¢ï¼šå·¦å³åˆ†æ å®¹å™¨ */
.game-content {
    display: flex;
    width: 100%;
    gap: 20px;
    margin: 14px 0;
    position: relative; /* ç¡®ä¿å†…å®¹åœ¨å°åŠ¨ç‰©å›¾æ ‡ä¸Šæ–¹ */
    z-index: 1;
}

/* é¢˜å¹²åŒºåŸŸï¼ˆå±…å·¦ï¼‰ */
.char-box{
    flex: 1; /* å å·¦ä¾§å®½åº¦ */
    text-align: center;
    margin: 14px 0;
    padding: 10px;
}
.char-box .word{font-size:72px;font-weight:900;color:var(--c1);text-align: center;display:block}
.meta{font-size:16px;margin-top:6px;color:#333;text-align: center}
.play-btn{margin-top:8px;padding:8px 14px;border:none;border-radius:12px;text-align: center;
  background:linear-gradient(90deg,var(--c3),var(--c4));color:#fff;font-weight:800;cursor:pointer}

/* é€‰é¡¹åŒºåŸŸï¼ˆå±…å³ï¼‰ */
.choices{
    flex: 1; /* å å³ä¾§å®½åº¦ */
    display: flex; /* æ”¹ä¸ºflexå¸ƒå±€ */
    flex-direction: column; /* å‚ç›´æ’åˆ— */
    gap: 12px;
    margin-top: 14px; /* ä¸é¢˜å¹²é¡¶éƒ¨å¯¹é½ */
}
.choice{padding:16px;border-radius:14px;font-weight:900;font-size:22px;cursor:pointer;
  background:linear-gradient(135deg,#FFFDE7,#FFF9C4);border:3px solid rgba(0,0,0,0.03);transition:.12s;
  text-align: center; /* é€‰é¡¹æ–‡å­—å±…ä¸­ */
}
.choice:hover{transform:translateY(-4px)}
.choice.correct{background:linear-gradient(135deg,#DCEDC8,#A5D6A7);border-color:#43A047;color:#1B5E20}
.choice.wrong{background:linear-gradient(135deg,#FFCDD2,#EF9A9A);border-color:#E53935;color:#B71C1C}
.progress{height:14px;background:#eee;border-radius:8px;overflow:hidden;margin-top:12px}
.progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--c2),var(--c1))}
.next-btn{background:linear-gradient(90deg,var(--c4),var(--c5));border:none;color:#fff;padding:10px 16px;
  border-radius:12px;font-weight:900;margin-top:12px;cursor:pointer}
.home-btn{background:#fff;border:2px dashed var(--c4);padding:8px 12px;border-radius:12px;cursor:pointer;margin-top:12px}

/* å½•éŸ³è¡Œ */
.rec-row{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
.rec-btn{padding:8px 12px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
.rec-indicator{font-size:13px;color:#666;margin-left:6px}
.transcript{font-weight:800;padding:6px 8px;border-radius:8px;border:2px solid transparent;margin-left:10px;min-width:160px;text-align:center}

/* å½•éŸ³æ’­æ”¾æ”¾åœ¨å½•éŸ³æŒ‰é’®æ­£ä¸‹æ–¹å¹¶å±…ä¸­ */
.rec-play-wrap{display:flex;flex-direction:column;align-items:center;margin-top:10px}

/* å“åº”å¼è°ƒæ•´ï¼ˆæ‰‹æœºç«¯æ¢å¤ä¸Šä¸‹å¸ƒå±€ï¼‰ */
@media (max-width:760px){
    .game-content { flex-direction: column; }
    .char-box { text-align: center; }
    .rec-row { justify-content: center; }
    .choices { margin-top: 12px; }
    .char-box .word{font-size:48px}
}

/* ç»“æŸé¡µ */
#end{display:none;text-align:center}
.end-card{padding:20px;border-radius:16px;background:linear-gradient(135deg,#FFF3E0,#FFE0B2)}
.score-big{font-size:36px;font-weight:900;color:var(--c1);margin:10px 0}
.encourage{margin-top:12px;font-size:18px;font-weight:900;color:var(--c5)}

footer{margin-top:16px;text-align:center;color:#999;font-weight:700}
  </style>
</head>
<body>
  <div class="animal-emoji animal-1">ğŸ°</div>
  <div class="animal-emoji animal-2">ğŸ¯</div>
  <div class="animal-emoji animal-3">ğŸµ</div>
  <div class="animal-emoji animal-4">ğŸ¶</div>
  <div class="animal-emoji animal-5">ğŸ¦</div>
  <div class="animal-emoji animal-6">ğŸ˜</div>

  <div class="wrap" role="application" aria-label="è¯è¯­æ‹¼è¯»ç»ƒä¹ ">
    <header>
      <div class="logo">å£°</div>
      <h1>è¯è¯­æ‹¼è¯»ç»ƒä¹ </h1>
    </header>

    <main>
      <!-- HOME -->
      <section id="home">
        <div class="card">
          <div style="font-weight:900">è¯·é€‰æ‹©å¹´çº§</div>
          <div class="grade-selects" id="grade-selects">
            <div class="grade-btn" data-grade="1">ä¸€å¹´çº§<br><span style="font-size:13px;opacity:.9">æš‚ç©º</span></div>
            <div class="grade-btn" data-grade="2">äºŒå¹´çº§<br><span style="font-size:13px;opacity:.9">æš‚ç©º</span></div>
            <div class="grade-btn" data-grade="3">ä¸‰å¹´çº§<br><span style="font-size:13px;opacity:.9">æš‚ç©º</span></div>
            <div class="grade-btn" data-grade="4">å››å¹´çº§<br><span style="font-size:13px;opacity:.9">å·²åŠ è½½è¯è¯­</span></div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:900">é¢˜ç›®æ•°é‡</div>
          <div class="num-select" id="num-select">
            <div class="num-btn" data-num="10">10</div>
            <div class="num-btn" data-num="20">20</div>
            <div class="num-btn" data-num="30">30</div>
            <div class="num-btn" data-num="40">40</div>
            <div class="num-btn selected" data-num="all">å…¨éƒ¨</div>
          </div>
          <div class="custom-box">
            <label for="custom-num" style="font-weight:800">è‡ªå®šä¹‰ï¼š</label>
            <input id="custom-num" class="custom-input" type="number" min="1" placeholder="æ•°é‡">
            <div style="font-size:13px;color:#666">ï¼ˆè¶…è¿‡æœ€å¤§å€¼ä¼šè‡ªåŠ¨å–æœ€å¤§ï¼‰</div>
          </div>
        </div>

        <button id="start-game" class="start-btn">å¼€å§‹ç»ƒä¹  âœ¨</button>
      </section>

<!-- GAME -->
<section id="game" aria-live="polite">
  <div class="topbar" style="display:flex;justify-content:space-between;">
    <div id="game-grade" style="font-weight:900">å››å¹´çº§</div>
    <div id="q-count" style="font-weight:900">0 / 0</div>
  </div>

  <div class="game-content">
    <!-- å·¦ä¾§ï¼šé¢˜å¹² -->
    <div class="char-box">
      <span class="word" id="word-display">è¯è¯­</span>
      <div class="meta" id="meta-line">ï¼ˆè‹±æ–‡é‡Šä¹‰ï¼‰</div>
      <div style="margin-top:6px">
        <button id="play-sound" class="play-btn">ğŸ”Š æ’­æ”¾é¢˜å¹²éŸ³</button>
      </div>

      <!-- å½•éŸ³æ§ä»¶è¡Œï¼ˆå½•éŸ³æŒ‰é’® + è¯†åˆ«æ˜¾ç¤ºï¼‰ -->
      <div class="rec-row">
        <button id="rec-btn" class="rec-btn" style="background:linear-gradient(90deg,var(--c1),var(--c2));color:#fff">å½•éŸ³ â—</button>
        <button id="stop-rec-btn" class="rec-btn" style="background:linear-gradient(90deg,var(--c3),var(--c4));color:#fff;display:none">åœæ­¢</button>
        <span id="rec-status" class="rec-indicator">ï¼ˆæœªå½•éŸ³ï¼‰</span>
        <div id="transcript" class="transcript" title="è¯†åˆ«ç»“æœæ˜¾ç¤ºåœ¨è¿™é‡Œ">ï¼ˆè¯†åˆ«ç»“æœï¼‰</div>
      </div>

      <!-- å½•éŸ³å›æ”¾æ”¾åœ¨å½•éŸ³æŒ‰é’®æ­£ä¸‹æ–¹å¹¶å±…ä¸­ -->
      <div class="rec-play-wrap">
        <audio id="user-rec-audio" controls style="display:none;margin-top:8px"></audio>
      </div>
    </div>

    <!-- å³ä¾§ï¼šé€‰é¡¹ -->
    <div class="choices" id="choices"></div>
  </div>

  <!-- è¿›åº¦ / å¾—åˆ† -->
  <div class="progress"><div id="progress-bar"></div></div>
  <div id="score-text" style="margin-top:10px;font-weight:900">å¾—åˆ†ï¼š0</div>

  <div style="display:flex;gap:10px;margin-top:12px;justify-content: center;">
    <button id="next-btn" class="next-btn" style="display:none">ä¸‹ä¸€é¢˜ â¡</button>
    <button id="quit-btn" class="home-btn">ç»“æŸå¹¶è¿”å›</button>
  </div>
</section>

      <!-- END -->
      <section id="end">
        <div class="end-card">
          <div style="font-weight:900">æœ¬è½®å®Œæˆ ğŸ‰</div>
          <div class="score-big" id="final-score">0 / 0</div>
          <div class="encourage" id="encourage"></div>
          <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
            <button id="retry-btn" class="start-btn">å†æ¥ä¸€æ¬¡ ğŸ”</button>
            <button id="back-home-btn" class="home-btn">è¿”å›é¦–é¡µ ğŸ </button>
          </div>
        </div>
      </section>
    </main>

    <footer>å¿«ä¹å­¦æ±‰å­—/è¯è¯­ ğŸˆ</footer>
  </div>

  <audio id="audio" preload="auto" style="display:none"></audio>

  <script>
    /*************************************************************************
     * æ•°æ®ä¸è¯æ±‡ï¼ˆå·²æŠŠä¸€å¹´çº§-ä¸‰å¹´çº§ç•™ç©ºï¼Œå››å¹´çº§æŒ‰ä½ ç»™çš„è¯è¯­ï¼‰
     *************************************************************************/
    const gradeWords = {
      1: [],
      2: [],
      3: [],
      4: [
        "ä¸ªäºº","ç¤¾ä¼š","è§’è‰²","ä»£è¡¨","å…´è¶£","è§’è‰²","å®¶åº­","å­¦æ ¡","æ´»åŠ¨","è€å¸ˆ",
        "å¿ƒæƒ…","åšé¥­","è¡£æœ","é£Ÿç‰©","å”±æ­Œ","çœ‹ç”µå½±","è¯»ä¹¦","æ—¶å€™","äº²è¿‘","ä¸¾æ‰‹",
        "ç¬‘","åˆ†äº«","æ¯”èµ›","å‘¨æœ«","è‡ªå·±"
      ]
    };

    // æ¯ä¸ªæ±‰å­—çš„æ‹¼éŸ³åŸºç¡€ä¸å£°è°ƒï¼ˆä¸ºç”Ÿæˆ TTS å‚æ•°ä¸æ‹¼éŸ³é€‰é¡¹ï¼‰
    // åŒ…å«å››å¹´çº§æ‰€éœ€çš„å­—ç¬¦ï¼ˆè‹¥åç»­è¯æ±‡æ‰©å……ï¼Œè¯·è¡¥å……ï¼‰
    const pinyinMap = {
      "ä¸ª":{pinyinBase:"ge",tone:4},"äºº":{pinyinBase:"ren",tone:2},
      "ç¤¾":{pinyinBase:"she",tone:4},"ä¼š":{pinyinBase:"hui",tone:4},
      "è§’":{pinyinBase:"jue",tone:2},"è‰²":{pinyinBase:"se",tone:4},
      "ä»£":{pinyinBase:"dai",tone:4},"è¡¨":{pinyinBase:"biao",tone:3},
      "å…´":{pinyinBase:"xing",tone:4},"è¶£":{pinyinBase:"qu",tone:4},
      "å®¶":{pinyinBase:"jia",tone:1},"åº­":{pinyinBase:"ting",tone:2},
      "å­¦":{pinyinBase:"xue",tone:2},"æ ¡":{pinyinBase:"xiao",tone:4},
      "æ´»":{pinyinBase:"huo",tone:2},"åŠ¨":{pinyinBase:"dong",tone:4},
      "è€":{pinyinBase:"lao",tone:3},"å¸ˆ":{pinyinBase:"shi",tone:1},
      "å¿ƒ":{pinyinBase:"xin",tone:1},"æƒ…":{pinyinBase:"qing",tone:2},
      "åš":{pinyinBase:"zuo",tone:4},"é¥­":{pinyinBase:"fan",tone:4},
      "è¡£":{pinyinBase:"yi",tone:1},"æœ":{pinyinBase:"fu",tone:2},
      "é£Ÿ":{pinyinBase:"shi",tone:2},"ç‰©":{pinyinBase:"wu",tone:4},
      "å”±":{pinyinBase:"chang",tone:4},"æ­Œ":{pinyinBase:"ge",tone:1},
      "çœ‹":{pinyinBase:"kan",tone:4},"ç”µ":{pinyinBase:"dian",tone:4},"å½±":{pinyinBase:"ying",tone:3},
      "è¯»":{pinyinBase:"du",tone:2},"ä¹¦":{pinyinBase:"shu",tone:1},
      "æ—¶":{pinyinBase:"shi",tone:2},"å€™":{pinyinBase:"hou",tone:4},
      "äº²":{pinyinBase:"qin",tone:1},"è¿‘":{pinyinBase:"jin",tone:4},
      "ä¸¾":{pinyinBase:"ju",tone:3},"æ‰‹":{pinyinBase:"shou",tone:3},
      "ç¬‘":{pinyinBase:"xiao",tone:4},"åˆ†":{pinyinBase:"fen",tone:1},"äº«":{pinyinBase:"xiang",tone:3},
      "æ¯”":{pinyinBase:"bi",tone:3},"èµ›":{pinyinBase:"sai",tone:4},
      "å‘¨":{pinyinBase:"zhou",tone:1},"æœ«":{pinyinBase:"mo",tone:4},
      "è‡ª":{pinyinBase:"zi",tone:4},"å·±":{pinyinBase:"ji",tone:3}
    };

    // å››å¹´çº§è¯è¯­çš„è‹±æ–‡é‡Šä¹‰ï¼ˆé™æ€å­—å…¸ï¼‰
    const lexiconWords = {
      "ä¸ªäºº":"personal; individual",
      "ç¤¾ä¼š":"society; social",
      "è§’è‰²":"role; character",
      "ä»£è¡¨":"representative; to represent",
      "å…´è¶£":"interest; hobby",
      "å®¶åº­":"family; household",
      "å­¦æ ¡":"school",
      "æ´»åŠ¨":"activity; event",
      "è€å¸ˆ":"teacher",
      "å¿ƒæƒ…":"mood; feeling",
      "åšé¥­":"to cook; cooking",
      "è¡£æœ":"clothes; clothing",
      "é£Ÿç‰©":"food",
      "å”±æ­Œ":"to sing; singing",
      "çœ‹ç”µå½±":"to watch a movie; watching movies",
      "è¯»ä¹¦":"to read; studying",
      "æ—¶å€™":"time; moment",
      "äº²è¿‘":"intimate; close",
      "ä¸¾æ‰‹":"to raise one's hand",
      "ç¬‘":"to laugh; smile",
      "åˆ†äº«":"to share",
      "æ¯”èµ›":"competition; match",
      "å‘¨æœ«":"weekend",
      "è‡ªå·±":"oneself; self"
    };

    /*************************************************************************
     * DOM references & state
     *************************************************************************/
    const gradeBtns = document.querySelectorAll(".grade-btn");
    const numBtns = document.querySelectorAll(".num-btn");
    const customInput = document.getElementById("custom-num");
    const startBtn = document.getElementById("start-game");
    const homeSection = document.getElementById("home");
    const gameSection = document.getElementById("game");
    const endSection = document.getElementById("end");
    const gameGradeEl = document.getElementById("game-grade");
    const qCountEl = document.getElementById("q-count");
    const wordDisplay = document.getElementById("word-display");
    const metaLineEl = document.getElementById("meta-line");
    const playSoundBtn = document.getElementById("play-sound");
    const choicesEl = document.getElementById("choices");
    const nextBtn = document.getElementById("next-btn");
    const quitBtn = document.getElementById("quit-btn");
    const progressBar = document.getElementById("progress-bar");
    const scoreText = document.getElementById("score-text");
    const finalScoreEl = document.getElementById("final-score");
    const encourageEl = document.getElementById("encourage");
    const retryBtn = document.getElementById("retry-btn");
    const backHomeBtn = document.getElementById("back-home-btn");
    const audioEl = document.getElementById("audio");

    // recording / recognition DOM
    const recBtn = document.getElementById("rec-btn");
    const stopRecBtn = document.getElementById("stop-rec-btn");
    const recStatus = document.getElementById("rec-status");
    const transcriptEl = document.getElementById("transcript");
    const userRecAudio = document.getElementById("user-rec-audio");

    // state
    let selectedGrade = 4;
    let selectedNum = "all";
    let customNum = null;
    let pool = []; // {word, syllables:[{char,pinyinBase,tone}]}
    let order = [];
    let cur = 0;
    let total = 0;
    let score = 0;

    // per-question flags to ensure both tasks (choice + correct rec) done
    let choiceSelected = false;
    let recDone = false;
    let recCorrect = false;

    // recording / recognition resources
    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let recognition = null; // SpeechRecognition instance

    // utility: shuffle
    function shuffleArray(a) {
      const arr = a.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // build pool for selected grade: each entry is {word,syllables:[{char,pinyinBase,tone}]}
    function buildPoolForGrade(g) {
      const list = gradeWords[g] || [];
      return list.map(w => {
        const syllables = [];
        for (const ch of w) {
          const info = pinyinMap[ch];
          if (info) syllables.push({char:ch,pinyinBase:info.pinyinBase,tone:info.tone || 0});
          else syllables.push({char:ch,pinyinBase:ch,tone:0});
        }
        return {word:w, syllables};
      });
    }

    // helper: mark tone on single-syllable pinyin (reuse simple version from original)
    function markTone(syllable, tone) {
      if (!tone || tone === 0) return syllable;
      let s = syllable.replace(/v/g,'Ã¼');
      const toneMap = {
        'a': ['Ä','Ã¡','Ç','Ã '],
        'o': ['Å','Ã³','Ç’','Ã²'],
        'e': ['Ä“','Ã©','Ä›','Ã¨'],
        'i': ['Ä«','Ã­','Ç','Ã¬'],
        'u': ['Å«','Ãº','Ç”','Ã¹'],
        'Ã¼': ['Ç–','Ç˜','Çš','Çœ']
      };
      const lower = s.toLowerCase();
      let targetIndex = -1;
      if (lower.includes('iu')) targetIndex = lower.indexOf('iu') + 1;
      else if (lower.includes('ui')) targetIndex = lower.indexOf('ui') + 1;
      else {
        const order = ['a','o','e','i','u','Ã¼'];
        for (let ch of order) {
          const idx = lower.indexOf(ch);
          if (idx !== -1) { targetIndex = idx; break; }
        }
      }
      if (targetIndex === -1) return s;
      const ch = s[targetIndex].toLowerCase();
      const marks = toneMap[ch];
      if (!marks) return s;
      const mark = marks[tone - 1];
      s = s.substring(0, targetIndex) + mark + s.substring(targetIndex + 1);
      if (['j','q','x'].includes(s[0]) && s.includes('Ã¼')) s = s.replace('Ã¼','u');
      return s;
    }

    // build full-word pinyin string (with tone marks) -> for options display
    function buildWordPinyinMarked(syllables) {
      // join syllables with spaces; each syllable use markTone(pinyinBase,tone)
      return syllables.map(s => markTone(s.pinyinBase, s.tone)).join(' ');
    }

    // build Baidu TTS tex parameter for a word:
    // Format per char: <char>(<pinyin><tone>)
    // Example for "ä¸ªäºº" -> "ä¸ª(ge4)äºº(ren2)"
    function buildBaiduTtsTexParam(syllables) {
      return syllables.map(s => `${s.char}(${s.pinyinBase}${s.tone || ''})`).join('');
    }

    // play TTS via Baidu public tts endpoint (client-side)
    function playBaiduTtsForWord(syllables) {
      const tex = buildBaiduTtsTexParam(syllables);
      const url = `https://tts.baidu.com/text2audio?tex=${encodeURIComponent(tex)}&cuid=dict&lan=ZH&ctp=2&pdt=30&vol=9`;
      audioEl.src = url;
      audioEl.play().catch(()=>{/* ignore play errors */});
    }

    // Improved: Generate 3 distractor pinyin strings using similar initials/finals/tones
    function generatePinyinOptions(syllables) {
      const correct = buildWordPinyinMarked(syllables);
      const variants = new Set([correct]);

      // Define similar initial groups
      const similarInitials = {
     "b": ["p", "d"],
      "p": ["b", "t"],
      "m": ["n", "f"],
      "f": ["m", "h"],
      "d": ["t", "b"],
      "t": ["d", "p"],
      "n": ["l", "m"],
      "l": ["n", "r"],
      "g": ["k", "h"],
      "k": ["g", "h"],
      "h": ["k", "g"],
      "j": ["q", "x"],
      "q": ["j", "x"],
      "x": ["j", "q"],
      "zh": ["ch", "sh","z"],
      "ch": ["zh", "sh","c"],
      "sh": ["ch", "zh","s"],
      "r": ["l", "y"],
      "z": ["c", "s"],
      "c": ["z", "s"],
      "s": ["z", "c"],
      "y": ["j","w"],
      "w": ["y","j"]
      };

      // Define similar final replacements (simple mappings)
      const similarFinals = {
    "a": ["ai", "an"],
      "o": ["ou", "ong"],
      "e": ["ei", "en"],
      "i": ["ie", "in"],
      "u": ["ui", "un"],
      "Ã¼": ["Ã¼e", "un"],
      "ai": ["a", "ei"],
      "ei": ["ai", "e"],
      "ui": ["u", "ou"],
      "ao": ["ou", "a"],
      "ou": ["ao", "ong"],
      "iu": ["i", "u"],
      "ie": ["i", "e"],
      "Ã¼e": ["Ã¼", "e"],
      "an": ["ang", "a"],
      "en": ["eng", "e"],
      "in": ["ing", "i"],
      "un": ["ong", "Ã¼e"],
      "ang": ["an", "a"],
      "eng": ["en", "e"],
      "ing": ["in", "i"],
      "ong": ["un", "ou"],
      "ia": ["ie", "iao"],
      "iao": ["ia", "ao"],
      "ian": ["iang", "an"],
      "iang": ["ian", "ang"],
      "iong": ["ong", "ing"],
      "ua": ["uo", "uai"],
      "uo": ["ua", "o"],
      "uai": ["ua", "ai"],
      "uan": ["uang", "an"],
      "uang": ["uan", "ang"],
      "er": ["e", "Ã¼e"]
      };

      // Function to perturb a syllable
      function perturbSyllable(item) {
        const copy = {...item};
        const r = Math.random();
        if (r < 0.4) {
          // Change tone to a different one (1-4)
          let newTone = copy.tone;
          while (newTone === copy.tone) newTone = Math.floor(Math.random() * 4) + 1;
          copy.tone = newTone;
        } else if (r < 0.7) {
          // Change initial to similar
          const base = copy.pinyinBase;
          const initialMatch = base.match(/^(zh|ch|sh|[bpmfdtnlgkhjqxrzcs])/);
          if (initialMatch) {
            const initial = initialMatch[0];
            const similars = similarInitials[initial] || [];
            if (similars.length > 0) {
              const newInit = similars[Math.floor(Math.random() * similars.length)];
              const rest = base.slice(initial.length);
              copy.pinyinBase = newInit + rest;
            }
          }
        } else {
          // Change final to similar
          const base = copy.pinyinBase;
          for (const final in similarFinals) {
            if (base.endsWith(final)) {
              const similars = similarFinals[final] || [];
              if (similars.length > 0) {
                const newFinal = similars[Math.floor(Math.random() * similars.length)];
                copy.pinyinBase = base.slice(0, -final.length) + newFinal;
              }
              break;
            }
          }
        }
        return copy;
      }

      while (variants.size < 4) {
        const copy = syllables.map(s => ({...s}));
        // Perturb one random syllable
        const idx = Math.floor(Math.random() * copy.length);
        copy[idx] = perturbSyllable(copy[idx]);
        const candidate = buildWordPinyinMarked(copy);
        if (candidate !== correct) {
          variants.add(candidate);
        }
      }

      // Return shuffled array
      return shuffleArray(Array.from(variants));
    }

    /*************************************************************************
     * Show question & handle choice logic + recording correctness logic
     *************************************************************************/
    function startGame() {
      pool = buildPoolForGrade(selectedGrade);
      // decide number of questions
      let n = pool.length;
      if (selectedNum === "10") n = Math.min(10, pool.length);
      else if (selectedNum === "20") n = Math.min(20, pool.length);
      else if (selectedNum === "30") n = Math.min(30, pool.length);
      else if (selectedNum === "40") n = Math.min(40, pool.length);
      else if (selectedNum === "custom" && customNum && customNum>0) n = Math.min(customNum, pool.length);

      if (n < pool.length) {
        pool = shuffleArray(pool).slice(0,n);
      }

      total = pool.length;
      score = 0; cur = 0;
      order = Array.from(Array(total).keys());
      order = shuffleArray(order);

      document.getElementById("home").style.display = "none";
      document.getElementById("game").style.display = "block";
      document.getElementById("end").style.display = "none";
      gameGradeEl.textContent = `å››å¹´çº§`;
      qCountEl.textContent = `${cur+1} / ${total}`;
      scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
      progressBar.style.width = `0%`;
      showQuestion(cur);
    }

    function showQuestion(index) {
      choiceSelected = false;
      recDone = false;
      recCorrect = false;
      nextBtn.style.display = "none";
      transcriptEl.textContent = "ï¼ˆè¯†åˆ«ç»“æœï¼‰";
      transcriptEl.style.borderColor = "transparent";
      transcriptEl.style.background = "transparent";
      transcriptEl.style.color = "#000";
      transcriptEl.title = "è¯†åˆ«ç»“æœæ˜¾ç¤ºåœ¨è¿™é‡Œ";
      userRecAudio.style.display = "none";
      userRecAudio.src = "";
      recStatus.textContent = "ï¼ˆæœªå½•éŸ³ï¼‰";

      const q = pool[order[index]];
      if (!q) return;
      wordDisplay.textContent = q.word;
      metaLineEl.textContent = lexiconWords[q.word] || "ï¼ˆè‹±æ–‡é‡Šä¹‰æš‚ç¼ºï¼‰";
      qCountEl.textContent = `${index+1} / ${total}`;
      const p = Math.round((index/Math.max(1,total))*100);
      progressBar.style.width = p + "%";

      // build options
      choicesEl.innerHTML = "";
      const opts = generatePinyinOptions(q.syllables);
      for (const text of opts) {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = text;
        btn.addEventListener("click", ()=> {
          // disable all options after click
          document.querySelectorAll(".choice").forEach(b => b.disabled = true);
          // correct check
          const correctStr = buildWordPinyinMarked(q.syllables);
          if (text === correctStr) {
            btn.classList.add("correct");
            score++;
            scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
          } else {
            btn.classList.add("wrong");
            // highlight correct
            Array.from(document.querySelectorAll(".choice")).forEach(b=>{
              if (b.textContent === correctStr) b.classList.add("correct");
            });
          }
          choiceSelected = true;
          // check if both tasks done
          checkIfReadyToNext();
        });
        choicesEl.appendChild(btn);
      }

      // autoplay TTS for question once
      playBaiduTtsForWord(q.syllables);
    }

    // check both flags then show next button
    function checkIfReadyToNext() {
      if (choiceSelected && recDone && recCorrect) {
        nextBtn.style.display = "inline-block";
      } else {
        nextBtn.style.display = "none";
      }
    }

    /*************************************************************************
     * Recording + SpeechRecognition logic
     *  - Start MediaRecorder to capture audio for playback
     *  - Start SpeechRecognition to get transcript
     *  - Display transcript in transcriptEl; color green if recognized string includes word chars
     *************************************************************************/
    async function ensureMediaStream() {
      if (mediaStream) return mediaStream;
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        return mediaStream;
      } catch (err) {
        console.error("æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼š", err);
        alert("æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®å¹¶å…è®¸éº¦å…‹é£è®¿é—®ã€‚");
        throw err;
      }
    }

    function createRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        recognition = null;
        return null;
      }
      const rec = new SpeechRecognition();
      rec.lang = 'zh-CN';
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      return rec;
    }

    recBtn.addEventListener("click", async ()=>{
      // prepare stream and recorder
      try {
        const stream = await ensureMediaStream();
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = function(e) {
          if (e.data && e.data.size > 0) recordedChunks.push(e.data);
        };
        mediaRecorder.onstart = function() {
          recStatus.textContent = "ï¼ˆæ­£åœ¨å½•éŸ³ï¼‰";
          recBtn.style.display = "none";
          stopRecBtn.style.display = "inline-block";
        };
        mediaRecorder.onstop = function() {
          const blob = new Blob(recordedChunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          userRecAudio.src = url;
          userRecAudio.style.display = "inline-block";
          recStatus.textContent = "ï¼ˆå·²å½•éŸ³ï¼‰";
          recBtn.style.display = "inline-block";
          stopRecBtn.style.display = "none";
          recDone = true;
          checkIfReadyToNext();
        };
        mediaRecorder.start();
      } catch (err) {
        console.error("media error", err);
        alert("æ— æ³•å¼€å§‹å½•éŸ³ï¼š" + err.message);
        return;
      }

      // start speech recognition
      if (!recognition) recognition = createRecognition();
      if (!recognition) {
        // If SpeechRecognition unsupported, inform user and still allow manual playback & use recorded audio to proceed?
        transcriptEl.textContent = "ï¼ˆæµè§ˆå™¨ä¸æ”¯æŒ SpeechRecognitionï¼‰";
        transcriptEl.style.color = "#B71C1C";
        transcriptEl.style.borderColor = "#E53935";
        transcriptEl.style.background = "#FFF3F3";
        return;
      }

      // clear previous transcript display
      transcriptEl.textContent = "ï¼ˆè¯†åˆ«ä¸­...ï¼‰";
      transcriptEl.style.borderColor = "transparent";
      transcriptEl.style.color = "#000";

      const q = pool[order[cur]];
      recognition.onresult = function(event) {
        const text = Array.from(event.results).map(r=>r[0].transcript).join('');
        // show recognition result
        transcriptEl.textContent = text || "ï¼ˆæœªè¯†åˆ«åˆ°ï¼‰";
        // check inclusion: if recognized text contains the characters in the question word
        const target = q.word;
        // consider basic normalization: remove spaces
        const normalized = text.replace(/\s+/g,'');
        let ok = true;
        // require that each char of target appears in normalized text (order-insensitive)
        for (const ch of target) {
          if (!normalized.includes(ch)) { ok = false; break; }
        }
        if (ok) {
          transcriptEl.style.borderColor = "#4CAF50";
          transcriptEl.style.background = "#E8F5E9";
          transcriptEl.style.color = "#1B5E20";
          transcriptEl.title = "è¯†åˆ«æ­£ç¡®";
          recCorrect = true;
        } else {
          transcriptEl.style.borderColor = "#E53935";
          transcriptEl.style.background = "#FFEBEE";
          transcriptEl.style.color = "#B71C1C";
          transcriptEl.title = "è¯†åˆ«ç»“æœæœªåŒ…å«é¢˜å¹²è¯è¯­å­—ç¬¦";
          recCorrect = false;
        }
        // update next-button status
        checkIfReadyToNext();
      };

      recognition.onerror = function(e) {
        console.warn('recognition error', e);
        transcriptEl.textContent = "ï¼ˆè¯†åˆ«å‡ºé”™ï¼‰";
        transcriptEl.style.borderColor = "#E53935";
        transcriptEl.style.background = "#FFEBEE";
        recCorrect = false;
        checkIfReadyToNext();
      };

      recognition.onend = function() {
        // recognition ended (either naturally or by stop)
      };

      try {
        recognition.start();
      } catch (err) {
        console.warn("recognition start err", err);
      }
    });

    stopRecBtn.addEventListener("click", ()=>{
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
      if (recognition) {
        try { recognition.stop(); } catch(e){}
      }
    });

    /*************************************************************************
     * play sound button uses Baidu TTS for current word
     *************************************************************************/
    playSoundBtn.addEventListener("click", ()=>{
      const q = pool[order[cur]];
      if (!q) return;
      playBaiduTtsForWord(q.syllables);
    });

    /*************************************************************************
     * navigation
     *************************************************************************/
    nextBtn.addEventListener("click", ()=>{
      cur++;
      if (cur < total) {
        showQuestion(cur);
      } else {
        finishRound();
      }
    });

    quitBtn.addEventListener("click", finishRound);

    function finishRound() {
      document.getElementById("game").style.display = "none";
      document.getElementById("end").style.display = "block";
      const percentage = Math.round((score/Math.max(1,total))*100);
      finalScoreEl.textContent = `${score} / ${total} = ${percentage}%`;
      encourageEl.textContent = percentage >= 80 ? "å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼" : (percentage >= 60 ? "åšå¾—ä¸é”™ï¼Œç»§ç»­åŠªåŠ›ï¼" : "å†ç»ƒç»ƒï¼Œå¾ˆå¿«ä¼šè¿›æ­¥çš„ï¼");
      // hide next button always
      nextBtn.style.display = "none";
    }

    retryBtn.addEventListener("click", ()=>{
      score = 0; cur = 0;
      order = shuffleArray(order);
      document.getElementById("end").style.display = "none";
      document.getElementById("game").style.display = "block";
      gameGradeEl.textContent = `å››å¹´çº§`;
      qCountEl.textContent = `${cur+1} / ${total}`;
      scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
      progressBar.style.width = `0%`;
      showQuestion(0);
    });

    backHomeBtn.addEventListener("click", ()=>{
      document.getElementById("end").style.display = "none";
      document.getElementById("game").style.display = "none";
      document.getElementById("home").style.display = "block";
    });

    // init interaction for grade / num buttons
    gradeBtns.forEach(btn=>{
      btn.addEventListener("click", () => {
        gradeBtns.forEach(b=>b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedGrade = parseInt(btn.dataset.grade,10);
      });
    });
    numBtns.forEach(btn=>{
      btn.addEventListener("click", () => {
        numBtns.forEach(b=>b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedNum = btn.dataset.num;
        customInput.value = ""; customNum = null;
      });
    });
    customInput.addEventListener("input", ()=>{
      const v = parseInt(customInput.value,10);
      if (!isNaN(v) && v>0) {
        numBtns.forEach(b=>b.classList.remove("selected"));
        selectedNum = "custom";
        customNum = v;
      } else {
        customNum = null;
      }
    });
    startBtn.addEventListener("click", startGame);

    // keyboard: Enter to start
    document.addEventListener("keydown",(e)=>{
      if (e.key === "Enter" && document.getElementById("home").style.display !== "none") {
        startBtn.click();
      }
    });

    // defaults
    document.querySelector('.grade-btn[data-grade="4"]').classList.add('selected');
    document.querySelector('.num-btn[data-num="all"]').classList.add('selected');

    // If user navigates away, stop recognition/recorder to avoid leaks
    window.addEventListener('beforeunload', ()=>{
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        try { mediaRecorder.stop(); } catch(e){}
      }
      if (recognition) {
        try { recognition.abort(); } catch(e){}
      }
    });

  </script>
</body>
</html>